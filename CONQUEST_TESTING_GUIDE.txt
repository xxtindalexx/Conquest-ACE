================================================================================
CONQUEST SERVER - COMPREHENSIVE TESTING GUIDE
================================================================================
Version: 1.3
Date: 2025-12-25
Purpose: Systematic testing of all implemented Conquest features

Legend:
  ‚úÖ = Can test now (code implemented)
  ‚ö†Ô∏è = Partial testing (some aspects need content)
  ‚ùå = Cannot test (requires content/weenie creation)
  üîß = Admin/developer tools required

================================================================================
TESTING ENVIRONMENT SETUP
================================================================================

PREREQUISITES:
1. Fresh character created (or use /grantxp to set specific levels)
2. Admin account with access level (for testing admin commands)
3. Test account without admin privileges (for player testing)
4. Multiple IP addresses or VM setup (for multi-account testing)
5. Database access to verify property changes
6. Server logs accessible for error checking

USEFUL ADMIN COMMANDS FOR TESTING:
- /grantxp [amount] - Grant XP to character
- /setlevel [level] - Set character level directly
- /create [wcid] - Create items by weenie ID
- /teleto [coords] - Teleport to specific coordinates
- /god - Enable god mode (invulnerability)
- /ungod - Disable god mode
- /cloak player - Appear as player (for PK testing)

================================================================================
1. PLAYER COMMANDS - BASIC FUNCTIONALITY
================================================================================

-------------------------------------------
TEST 1.1: /qb and /bonus Commands
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with known quest completion count
- Database access to verify QuestCount property

TEST STEPS:
1. Type `/qb` in-game
2. Type `/bonus` in-game

EXPECTED RESULTS:
- Both commands display identical output
- Shows "=== Quest Bonus (QB) ==="
- Shows "Total Quests Completed: [number]"
- Shows "XP Bonus: [percentage]%"
- Shows "(You gain [percentage]% extra XP from all sources)"

VERIFICATION:
- Formula: 0.01% per quest = (quest_count * 0.0001)
- Example: 1,000 quests = 10% bonus
- Example: 5,000 quests = 50% bonus

EDGE CASES:
[x] 0 quests completed (should show 0% bonus)
[x] 1 quest completed (should show 0.01% bonus)
[x] 10,000 quests (should show 100% bonus)

PASS CRITERIA:
‚úì Command executes without errors
‚úì Math is correct (quest count √ó 0.0001)
‚úì Both /qb and /bonus show same data

-------------------------------------------
TEST 1.2: /aug and /augs Commands
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with Conquest luminance augmentations purchased

TEST STEPS:
1. Type `/aug` in-game
2. Type `/augs` in-game

EXPECTED RESULTS:
- Both commands display identical output
- Shows "=== Conquest Luminance Augmentation Levels ==="
- Lists all 10 Conquest custom augmentation types:
  * Creature Magic (PropertyInt64.LumAugCreatureCount = 9007)
  * Item Magic (PropertyInt64.LumAugItemCount = 9008)
  * Life Magic (PropertyInt64.LumAugLifeCount = 9009)
  * Void Magic (PropertyInt64.LumAugVoidCount = 9010)
  * War Magic (PropertyInt64.LumAugWarCount = 9011)
  * Spell Duration (PropertyInt64.LumAugDurationCount = 9016)
  * Specialized Skills (PropertyInt64.LumAugSpecializeCount = 9017)
  * Summoning (PropertyInt64.LumAugSummonCount = 9018)
  * Melee Defense (PropertyInt64.LumAugMeleeCount = 9022)
  * Missile Defense (PropertyInt64.LumAugMissileCount = 9023)

NOTE: These are CUSTOM Conquest augmentations, NOT the retail AC augmentations
(Damage Rating, Crit Damage, etc.). The retail augmentations are not used.

VERIFICATION:
- Use admin command to set augmentation values
- Verify displayed values match database character_properties_int64 table
- Property types: 9007-9011, 9016-9018, 9022-9023

EDGE CASES:
[x] All augmentations at 0
[x] Mixed augmentation levels

PASS CRITERIA:
‚úì Command executes without errors
‚úì All 10 custom augmentation types displayed
‚úì Values match database properties (9007-9023 range)

-------------------------------------------
TEST 1.3: /top Leaderboard Commands
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Multiple characters with varying stats
- Database stored procedures created (TopQuestBonus, TopLevel, TopEnlightenment, TopBank, TopLum, TopAugmentations)

TEST STEPS:
1. Type `/top` (no parameters)
2. Type `/top qb`
3. Type `/top level`
4. Type `/top enl` or `/top enlightenment`
5. Type `/top bank`
6. Type `/top lum` or `/top luminance`
7. Type `/top augs` or `/top aug` or `/top augmentations`
8. Type `/top death` or `/top deaths`
9. Type `/top title` or `/top titles`
10. Type `/top invalid`

EXPECTED RESULTS:
1. Help message: "Specify a leaderboard: /top qb, /top level, /top enl, /top bank, /top lum, /top augs, /top deaths, or /top titles"
2. Shows "Top 25 Players by Quest Bonus:"
3. Shows "Top 25 Players by Level:"
4. Shows "Top 25 Players by Enlightenment:"
5. Shows "Top 25 Players by Banked Pyreals:"
6. Shows "Top 25 Players by Banked Luminance:"
7. Shows "Top 25 Players by Total Augmentations:" (sum of all 10 custom augmentation types)
8. Shows "Top 25 Players by Death Count:"
9. Shows "Top 25 Players by Title Count:"
10. Error: "Unknown leaderboard 'invalid'. Use: qb, level, enl, bank, lum, augs, deaths, titles"

VERIFICATION:
- Create test characters with known values
- Verify ranking is correct (highest to lowest)
- Verify numbers formatted with thousand separators (1,000,000)

EDGE CASES:
[x] No data in leaderboard (should show "No data available")
[x] Only 1 player in leaderboard
[x] Exactly 25 players
[x] More than 25 players (should only show top 25)
[x] Characters with ExcludeFromLeaderboards = 1 (should not appear)

PASS CRITERIA:
‚úì All 5 leaderboard types work
‚úì Rankings are accurate
‚úì Numbers formatted correctly
‚úì Cache refreshes after 15 minutes

-------------------------------------------
TEST 1.4: /bank and /b Commands
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Pyreals in inventory
- Luminance available
- Event Tokens (Dragon Coins - WCID 13370002) in inventory
- Access to database to verify balances

TEST STEPS - Balance Check:
1. Type `/b b` or `/bank balance`

EXPECTED RESULTS:
- Shows "[BANK] Your balances:"
- Shows "[BANK] Pyreals: [amount]"
- Shows "[BANK] Luminance: [amount]"
- Shows "[BANK] Event Tokens (Dragon Coins): [amount]"
- Shows "[BANK] Conquest Coins (non-transferable): [amount]"
- Shows "[BANK] Soul Fragments (non-transferable): [amount]"

TEST STEPS - Deposit All:
1. Get some pyreals, luminance, event tokens in inventory
2. Type `/b d` or `/bank deposit`

EXPECTED RESULTS:
- Message: "Deposited all Pyreals, Luminance, and Event Tokens!"
- Items removed from inventory
- Bank balance increases accordingly

TEST STEPS - Deposit Specific Amount:
1. Type `/b d p 1000` (deposit 1000 pyreals)
2. Type `/b d l 500` (deposit 500 luminance)
3. Type `/b d e 100` (deposit 100 event tokens)

EXPECTED RESULTS:
- Only specified amount deposited
- Appropriate success messages
- Balances update correctly

TEST STEPS - Withdraw:
1. Type `/b w p 1000` (withdraw 1000 pyreals)
2. Type `/b w l 500` (withdraw 500 luminance)
3. Type `/b w e 100` (withdraw 100 event tokens)

EXPECTED RESULTS:
- Items appear in inventory
- Bank balance decreases
- MMDs created when withdrawing >250,000 pyreals in batches

TEST STEPS - Transfer:
1. Create second character "TestChar2"
2. On first character: `/b t p 1000 TestChar2`
3. On first character: `/b t l 500 TestChar2`
4. On first character: `/b t e 100 TestChar2`

EXPECTED RESULTS:
- Sender sees: "Transferred [amount] [currency] to TestChar2"
- Recipient's bank balance increases
- Works for both online and offline recipients

EDGE CASES:
[x] Deposit with no items
[x] Withdraw more than banked amount
[x] Withdraw while inventory full
[x] Transfer to non-existent character
[ ] Transfer while busy/teleporting
[x] Transfer negative amounts
[x] Transfer 0 amount
[ ] Transfer to character with spaces in name (use quotes)

PASS CRITERIA:
‚úì All deposit/withdraw operations work correctly
‚úì Transfers work for online and offline players
‚úì Error messages appropriate
‚úì Balances accurate in database
‚úì Conquest Coins and Soul Fragments show in balance but cannot transfer

-------------------------------------------
TEST 1.5: /pk Command - PK Flagging
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- NPK (non-PK) character
- Second character for PvP testing

TEST STEPS - Check Status:
1. Type `/pk` (no parameters)

EXPECTED RESULTS:
- Shows "Your PK status is currently OFF. Use '/pk on' or '/pk off' to change."

TEST STEPS - Turn PK On:
1. Type `/pk on`
2. Note the warning message
3. Type `/pk on confirm`

EXPECTED RESULTS:
1. Warning message:
   - "=== WARNING ==="
   - "Enabling PK status will allow other PK players to attack you anywhere in the world!"
   - "Type '/pk on confirm' to proceed."
2. Success message: "You are now a Player Killer! Other PK players can attack you anywhere."
3. Server broadcast: "[YourName] is now a Player Killer!"
4. PK status visible to other players

TEST STEPS - Attempt to Turn PK On Again:
1. Type `/pk on`

EXPECTED RESULTS:
- Message: "You are already a player killer."

TEST STEPS - Turn PK Off Too Soon:
1. Immediately after turning PK on, type `/pk off`

EXPECTED RESULTS:
- Message: "You must remain PK for at least 5 minutes after flagging. [X] minute(s) remaining."

TEST STEPS - Turn PK Off After 5 Minutes:
1. Wait 5+ minutes
2. Type `/pk off`

EXPECTED RESULTS:
- Message: "You are no longer a Player Killer. You are now safe from PvP attacks."
- PK status removed

TEST STEPS - PK Death Cooldown:
1. Turn PK on
2. Have another PK player kill you
3. Wait for respawn
4. Type `/pk on`

EXPECTED RESULTS:
- Message: "You must wait [X] more minute(s) before you can flag PK again after dying in PvP combat."
- Must wait 20 minutes after PK vs PK death

TEST STEPS - PK Timer Active:
1. Turn PK on
2. Attack another PK player (don't kill, just engage combat)
3. Immediately type `/pk off`

EXPECTED RESULTS:
- Message: "You cannot disable PK status while your PK timer is active (lasts 20 seconds after PK combat)."

EDGE CASES:
[ ] Try `/pk off` while in PK-only dungeon (needs content setup)
[x] Try `/pk on` while already PK
[x] Try `/pk off` while not PK
[x] Try `/pk invalidparam`

PASS CRITERIA:
‚úì 5-minute minimum duration enforced
‚úì 20-minute death cooldown enforced
‚úì PK timer prevents immediate unflagging
‚úì Confirmation required for `/pk on`
‚úì Server broadcasts work
‚úì LastPKFlagTime and LastPKDeathTime properties set correctly

================================================================================
2. ENLIGHTENMENT (ENL) SYSTEM
================================================================================

-------------------------------------------
TEST 2.1: ENL Cap at 100
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Admin access to set Enlightenment value

TEST STEPS:
1. Use admin command to set Enlightenment to 100
2. Verify in stats panel
3. Use admin command to set Enlightenment to 150

EXPECTED RESULTS:
- Setting to 100 works
- Setting to 150 should cap at 100

VERIFICATION:
- Check PropertyInt.Enlightenment = 390 in database
- Value should never exceed 100

PASS CRITERIA:
‚úì Cannot exceed 100 ENL
‚úì Database enforces cap

-------------------------------------------
TEST 2.2: ENL XP Bonus (+1% per ENL)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with 0 ENL
- Character with 50 ENL
- Character with 100 ENL
- Mob to kill for XP testing

TEST STEPS:
1. Record base XP from killing identical mob at 0 ENL
2. Set ENL to 50, kill same mob, record XP
3. Set ENL to 100, kill same mob, record XP

EXPECTED RESULTS:
- 0 ENL: Base XP (e.g., 1,000 XP)
- 50 ENL: Base XP √ó 1.5 (1,500 XP)
- 100 ENL: Base XP √ó 2.0 (2,000 XP)

FORMULA:
- XP Modifier = 1.0 + (ENL * 0.01)

PASS CRITERIA:
‚úì XP scales linearly with ENL
‚úì 100 ENL = double XP

-------------------------------------------
TEST 2.3: ENL Attribute Bonus (+1 per ENL)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with known base attributes
- Admin access to modify ENL

TEST STEPS:
1. Record all 6 base attributes (STR, END, COORD, QUICK, FOCUS, SELF) at 0 ENL
2. Set ENL to 50
3. Record all 6 attributes again
4. Set ENL to 100
5. Record all 6 attributes again

EXPECTED RESULTS:
- Each ENL point adds +1 to ALL 6 attributes
- 50 ENL: All attributes +50
- 100 ENL: All attributes +100

VERIFICATION:
- Check character stats panel
- Verify all 6 attributes increase equally

PASS CRITERIA:
‚úì All 6 attributes increase by ENL amount
‚úì Bonus applies to current stats (base + buffs + ENL)

-------------------------------------------
TEST 2.4: ENL Rating Bonus (+1 DR/DDR per 25 ENL)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with 0 ENL
- Access to damage rating stats

TEST STEPS:
1. Record Damage Rating and Damage Resistance Rating at 0 ENL
2. Set ENL to 25, record ratings
3. Set ENL to 50, record ratings
4. Set ENL to 75, record ratings
5. Set ENL to 100, record ratings

EXPECTED RESULTS:
- 0 ENL: Base ratings
- 25 ENL: Base + 1 DR, Base + 1 DRR
- 50 ENL: Base + 2 DR, Base + 2 DRR
- 75 ENL: Base + 3 DR, Base + 3 DRR
- 100 ENL: Base + 4 DR, Base + 4 DRR

FORMULA:
- Rating Bonus = ENL / 25 (integer division)

PASS CRITERIA:
‚úì Every 25 ENL adds +1 to both DR and DRR
‚úì Partial increments don't add rating (24 ENL = 0 bonus)

-------------------------------------------
TEST 2.5: ENL Leaderboard
-------------------------------------------
‚úÖ Can Test Now (if stored procedure exists)

TEST STEPS:
1. Create characters with different ENL values
2. Type `/top enl`

EXPECTED RESULTS:
- Shows "Top 50 Players by Enlightenment:"
- Ranked highest to lowest ENL
- Proper formatting

PASS CRITERIA:
‚úì Accurate rankings
‚úì Updates when ENL changes

================================================================================
3. QUEST BONUS (QB) SYSTEM
================================================================================

-------------------------------------------
TEST 3.1: Quest Completion Tracking
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Access to quest system
- Multiple unique quests to complete

TEST STEPS:
1. Check initial QB count with `/qb`
2. Complete a quest for the first time
3. Check QB count again
4. Repeat the same quest
5. Check QB count again

EXPECTED RESULTS:
1. Initial count displayed
2. QB count increases by 1
3. Message: "You've stamped [QuestName]!" (first completion)
4. QB count does NOT increase (repeat doesn't count)
5. No stamp message on repeat

VERIFICATION:
- Check PropertyInt64.QuestCount = 9027 in database
- Check account_quest table for quest entries

EDGE CASES:
[x] Complete quest on alt character (same account)
[x] Complete same quest after server restart
[x] Quest with multiple solves (should only stamp once)

PASS CRITERIA:
‚úì Only first completion counts toward QB
‚úì Repeats don't increment QB
‚úì Account-wide tracking works
‚úì Stamp message appears on first completion

-------------------------------------------
TEST 3.2: QB XP Bonus Calculation
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character with known QB count
- Mob for XP testing

TEST STEPS:
1. Set QB to 0, kill mob, record XP
2. Set QB to 1000, kill same mob, record XP
3. Set QB to 5000, kill same mob, record XP

EXPECTED RESULTS:
- 0 QB: Base XP
- 1,000 QB: Base XP √ó 1.10 (+10%)
- 5,000 QB: Base XP √ó 1.50 (+50%)

FORMULA:
- QB Modifier = 1.0 + (QB * 0.0001)
- Example: 3,000 quests = 1.0 + (3000 √ó 0.0001) = 1.30 (30% bonus)

BONUS STACKING (MULTIPLICATIVE):
All XP bonuses multiply together, NOT add:
- Quest Bonus: 1.0 + (QB √ó 0.0001)
- Enlightenment: 1.0 + (ENL √ó 0.01)
- Equipment: 1.0 + (Equipment XP bonus as decimal)
- PK Dungeon: 1.10 (if in PK dungeon, otherwise 1.0)

Total XP = Base XP √ó Quest √ó Enlightenment √ó Equipment √ó PK Dungeon

MULTIPLICATIVE vs ADDITIVE EXAMPLE (1,000 Base XP):
Scenario: 3000 QB (30%), ENL 50 (50%), Equipment 11%

MULTIPLICATIVE (Actual System):
- 1,000 √ó 1.30 √ó 1.50 √ó 1.11 = 2,164.5 XP
- Total Bonus: 116.45%

ADDITIVE (If bonuses added):
- 1,000 √ó 1.91 (30% + 50% + 11%) = 1,910 XP
- Total Bonus: 91%

DIFFERENCE: 254.5 more XP with multiplicative (13.3% more)

PRACTICAL EXAMPLES:
1. 100 ENL + 5000 QB + 0% Equipment + Not in PK dungeon:
   - 1,000 base √ó 2.0 √ó 1.5 √ó 1.0 √ó 1.0 = 3,000 XP (200% bonus)

2. 50 ENL + 3000 QB + 11% Equipment + PK dungeon:
   - 1,000 base √ó 1.5 √ó 1.3 √ó 1.11 √ó 1.1 = 2,380 XP (138% bonus)

3. 99 ENL + 22 QB + 4% Equipment + Not in PK dungeon:
   - 1,000 base √ó 1.99 √ó 1.0022 √ó 1.04 √ó 1.0 = 2,074 XP (107.4% bonus)

VERIFICATION:
Use `/bonus` command to see breakdown:
- Quest Bonus: X.XX% (Y quests)
- Enlightenment Bonus: X.XX% (Enlightenment Z)
- PK Dungeon Bonus: X.XX%
- Equipment Bonus: X.XX%
- Total Bonus: X.XX% (multiplicative total)

PASS CRITERIA:
‚úì XP scales correctly with QB count
‚úì Bonuses multiply, not add
‚úì `/bonus` command shows correct total percentage

-------------------------------------------
TEST 3.3: QB Leaderboard
-------------------------------------------
‚úÖ Can Test Now (if stored procedure exists)

TEST STEPS:
1. Create characters with different QB counts
2. Type `/top qb`

EXPECTED RESULTS:
- Shows "Top 50 Players by Quest Bonus:"
- Ranked highest to lowest QB
- Proper formatting

PASS CRITERIA:
‚úì Accurate rankings
‚úì Updates when QB changes

-------------------------------------------
TEST 3.4: Mule Character Exclusion
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Character flagged as mule (IsMule = true)

TEST STEPS:
1. Set character IsMule = true in database
2. Complete a quest

EXPECTED RESULTS:
- Quest completes normally
- QB count does NOT increase
- No stamp message

PASS CRITERIA:
‚úì Mules don't earn QB
‚úì No error messages

================================================================================
4. BANKING SYSTEM
================================================================================

-------------------------------------------
TEST 4.1: Pyreals Banking
-------------------------------------------
‚úÖ Can Test Now

See Test 1.4 for detailed banking tests.

ADDITIONAL TESTS:
[x] Deposit pyreals when BankedPyreals is null (first use)
[ ] Withdraw creates MMDs for amounts >250k
[ ] Withdraw creates proper stacks (max 25k per pyreal stack)
[ ] Transfer logs to transfer_log table
[ ] Concurrent deposits (thread safety)

-------------------------------------------
TEST 4.2: Luminance Banking
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Gain some luminance
2. `/b d l` to deposit all
3. `/b w l 500` to withdraw
4. Verify cannot exceed MaximumLuminance

EXPECTED RESULTS:
- Luminance transfers correctly
- Cannot withdraw if it would exceed max luminance

PASS CRITERIA:
‚úì Deposits work
‚úì Withdrawals work
‚úì Max luminance enforced

-------------------------------------------
TEST 4.3: Event Tokens (Dragon Coins)
-------------------------------------------
‚ùå Cannot Test (requires WCID 13370002 weenie creation)

Once weenie exists:
[ ] Deposit Dragon Coins
[ ] Withdraw Dragon Coins (max stack 25,000)
[ ] Transfer Dragon Coins to another player
[ ] Verify transfer logs

-------------------------------------------
TEST 4.4: Conquest Coins (Non-Transferable)
-------------------------------------------
‚ö†Ô∏è Partial Test (property exists, no acquisition method yet)

TEST STEPS:
1. Use admin command to set ConquestCoins value
2. Type `/b b` to view balance
3. Attempt to transfer conquest coins

EXPECTED RESULTS:
- Balance displays correctly
- Transfer should fail or not be available

-------------------------------------------
TEST 4.5: Soul Fragments (Non-Transferable)
-------------------------------------------
‚ö†Ô∏è Partial Test (property exists, no acquisition method yet)

TEST STEPS:
1. Use admin command to set SoulFragments value
2. Type `/b b` to view balance
3. Attempt to transfer soul fragments

EXPECTED RESULTS:
- Balance displays correctly
- Transfer should fail or not be available

================================================================================
5. PK SYSTEM & SOUL FRAGMENTS
================================================================================

-------------------------------------------
TEST 5.1: PK Flagging (Already covered in 1.5)
-------------------------------------------
‚úÖ See Test 1.5

-------------------------------------------
TEST 5.2: No Item Loss on PK Death
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two PK characters
- Items in inventory

TEST STEPS:
1. Turn both characters PK
2. Character A fills inventory with items
3. Character B kills Character A
4. Check Character A's corpse

EXPECTED RESULTS:
- Corpse contains NO items
- All items remain in Character A's inventory after death
- Normal death penalties apply (vitae, etc.)

COMPARISON:
- NPK death to mob: Items drop according to level
- PK death to player: NO items drop

PASS CRITERIA:
‚úì Zero items drop on PK death
‚úì Items remain in inventory
‚úì Corpse is empty

-------------------------------------------
TEST 5.3: Soul Fragment Drops on PK Death
-------------------------------------------
‚ùå Cannot Test (requires WCID 999999998 Soul Fragment weenie)

Once weenie exists:
[ ] PK vs PK death drops 1-3 Soul Fragments
[ ] Fragments go to killer's inventory
[ ] Only players LEVEL 50 OR HIGHER can drop fragments when killed in PvP
[ ] Players under level 50: no fragments drop on PvP death
[ ] 6-8 hour cooldown enforced (random)
[ ] Second PK death within cooldown: no fragments
[ ] Check PropertyInt64.LastSoulFragmentLootTime

NOTE: The level 50 requirement ONLY applies to PvP deaths. Monster kills in PK dungeons
can drop fragments regardless of player level (see TEST 5.4).

-------------------------------------------
TEST 5.4: PK Dungeon Soul Fragment Drops
-------------------------------------------
‚ùå Cannot Test (requires PK dungeon setup + weenie)

Once PK dungeons configured:
[ ] 0.75% drop chance per mob kill in PK dungeon
[ ] NO level requirement for monster drops (only PvP deaths require level 50)
[ ] Daily cap of 20 Soul Fragments
[ ] Message: "You found a Soul Fragment! (X remaining today)"
[ ] Daily reset after 24 hours
[ ] PropertyInt64.DailySoulFragmentCount
[ ] PropertyInt64.LastSoulFragmentResetTime

DAILY CAP NOTIFICATION TEST:
[ ] Kill mobs until daily cap reached (20 fragments)
[ ] Verify notification appears: "You have reached your daily Soul Fragment limit (20/20). Your limit will reset in Xh Ym Zs."
[ ] Notification only appears once every 5 minutes (throttled)
[ ] PropertyInt64.LastSoulFragmentCapNotifyTime tracks last notification
[ ] Countdown format: "Xh Ym Zs" (hours/minutes/seconds)
[ ] After reset time passes, can earn fragments again

-------------------------------------------
TEST 5.5: PK Dungeon +10% XP/Lum Bonus
-------------------------------------------
‚ö†Ô∏è Cannot Test (requires PK dungeon landblock configuration)

Once pkDungeonLandblocks populated:
[ ] NPK player: normal XP/lum
[ ] PK player in PK dungeon: +10% XP/lum
[ ] PK player outside PK dungeon: normal XP/lum

-------------------------------------------
TEST 5.6: PK Dungeon Enforcement
-------------------------------------------
‚ö†Ô∏è Cannot Test (requires PK dungeon configuration)

Once configured:
[ ] NPK player enters PK dungeon variant
[ ] Player teleported to lifestone after ~5 seconds
[ ] Message explains PK requirement
[ ] PK players can enter freely
[ ] Admin characters bypass enforcement

-------------------------------------------
TEST 5.7: PK Dungeon Re-Entry Cooldown (20-Minute Per-Dungeon Lockout)
-------------------------------------------
‚ö†Ô∏è Cannot Test (requires PK dungeon configuration)

Once configured:
[ ] PK player dies to another PK player in dungeon (PvP death ONLY)
[ ] 20-minute cooldown starts for THAT SPECIFIC DUNGEON
[ ] Attempting re-entry to same dungeon teleports to lifestone
[ ] Message: "You cannot re-enter this dungeon for X minutes and Y seconds after your death."
[ ] Can enter OTHER PK dungeons immediately (lockout is per-dungeon)
[ ] Death to mob: NO cooldown applied
[ ] PropertyInt64.LastPKDungeonDeathLocation stores dungeon landblock ID
[ ] PropertyInt64.LastPKDungeonDeathTime stores timestamp of death

VERIFICATION:
- Kill player in PK dungeon "A" (landblock 002A)
- Verify cannot re-enter dungeon "A" for 20 minutes
- Verify CAN enter dungeon "B" (different landblock) immediately
- After 20 minutes, verify can re-enter dungeon "A"

NOTE: This is implemented in Player_Tick.cs and enforced every 5 seconds during tick.
The landblock check is done via CurrentLandblock.Id.Landblock comparison.

================================================================================
6. MARKETPLACE & CHARACTER LIMITS
================================================================================

-------------------------------------------
TEST 6.1: Multiple Characters in Marketplace
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Multiple accounts or VM with different IPs
- OR single IP (to test same-IP behavior)

TEST STEPS:
1. Login Character A to Marketplace (Landblock 0x016C)
2. Login Character B (same IP) to Marketplace
3. Login Character C (same IP) to Marketplace

EXPECTED RESULTS:
- All characters can coexist in Marketplace
- No boot messages
- Unlimited characters allowed

PASS CRITERIA:
‚úì Unlimited characters in Marketplace
‚úì Works from same IP
‚úì No connection limits

-------------------------------------------
TEST 6.2: Single Character Outside Marketplace
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two characters from same IP

TEST STEPS:
1. Login Character A, portal OUT of Marketplace to town
2. Login Character B, portal OUT of Marketplace to different town
3. Wait a few seconds

EXPECTED RESULTS:
- One character gets booted
- Message: "Only 1 character per IP allowed outside Marketplace. Please return to Marketplace to switch characters."
- Teleport back to lifestone or disconnect

VERIFICATION:
- Check Config.js: MaximumCharactersOutsideMarketplace = 1

EDGE CASES:
[ ] Both characters in apartments (should work - exempt landblock)
[ ] One in Marketplace, one outside (should work)
[ ] Both outside Marketplace (one gets booted)
[ ] Admin character bypasses limit

PASS CRITERIA:
‚úì Only 1 character per IP outside exempt areas
‚úì Unlimited in Marketplace
‚úì Boot message displayed
‚úì Admin characters exempt

-------------------------------------------
TEST 6.3: Apartment Exemption
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Login Character A to apartment landblock
2. Login Character B to different apartment
3. Both should stay connected

EXPECTED RESULTS:
- Both characters remain connected
- Apartments are exempt landblocks

VERIFICATION:
- Apartment landblock ranges: 0x7200-0x9900, 0x5360-0x5369

PASS CRITERIA:
‚úì Multiple characters in apartments works
‚úì No boot messages

================================================================================
7. TINKERING SYSTEM
================================================================================

-------------------------------------------
TEST 7.1: 20x Tinkering Support
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Item to tinker
- Salvage materials
- High enough tinkering skill

TEST STEPS:
1. Tinker an item to 1x
2. Continue tinkering to 10x
3. Continue tinkering to 11x
4. Continue tinkering to 20x
5. Attempt 21st tink

EXPECTED RESULTS:
- Tinks 1-10: Standard difficulty progression
- Tinks 11-20: Increased difficulty (+0.5 per attempt)
- Tink 20: Difficulty multiplier = 9.5
- Tink 21: Should fail (not supported)

VERIFICATION:
- Check RecipeManager.cs TinkeringDifficulty list
- Verify 20 entries exist

PASS CRITERIA:
‚úì Can tinker to 20x
‚úì Cannot tinker beyond 20x
‚úì Difficulty increases correctly

================================================================================
8. VPN DETECTION SYSTEM
================================================================================

-------------------------------------------
TEST 8.1: VPN Detection on Login
-------------------------------------------
‚ö†Ô∏è Requires proxycheck.io API key

PREREQUISITES:
- proxycheck_api_key configured in Config.js
- VPN connection active

TEST STEPS:
1. Connect via VPN
2. Attempt to login

EXPECTED RESULTS:
- Login blocked
- Message about VPN usage not allowed
- IP added to blocklist cache

VERIFICATION:
- Check server logs for VPN detection
- Verify IP in blocklist cache

-------------------------------------------
TEST 8.2: VPN Blocklist Management
-------------------------------------------
üîß Admin Only

TEST STEPS:
1. Admin: `/clearvpnblocklist`
2. Admin: `/removeipfromvpnblocklist [IP]`

EXPECTED RESULTS:
- Blocklist cleared or specific IP removed
- Confirmation messages

PASS CRITERIA:
‚úì Commands execute without errors
‚úì IPs can be managed

================================================================================
9. LEADERBOARD CACHING
================================================================================

-------------------------------------------
TEST 9.1: Leaderboard Cache Refresh
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Type `/top qb` and note timestamp
2. Wait 15+ minutes
3. Type `/top qb` again
4. Check server logs for cache refresh

EXPECTED RESULTS:
- Data served from cache (fast response)
- After 15 minutes + variance: cache refreshes
- New data loaded from database

VERIFICATION:
- Check LeaderboardExtensions.cs for cache expiry logic
- Verify 15-minute base + 15-120 second variance

PASS CRITERIA:
‚úì Cache serves data quickly
‚úì Auto-refresh after expiry
‚úì No database thrashing

================================================================================
10. AUGMENTATION GEM SYSTEM
================================================================================

-------------------------------------------
TEST 10.1: Augmentation Gem Usage
-------------------------------------------
‚ùå Cannot Test (requires augmentation gem weenies)

Once gems created:
[ ] Purchase +1 gem from vendor (costs Conquest Coins)
[ ] Use gem on character (costs Luminance)
[ ] Verify augmentation increases
[ ] Repeat with +5 gem
[ ] Check luminance consumption rates

Expected consumption (from EmoteManager_AugGems.cs):
- Cost = (current level + increment) ^ 2 * 100
- Example: +1 gem at level 0 = (0 + 1)^2 * 100 = 100 lum
- Example: +5 gem at level 10 = (10 + 5)^2 * 100 = 22,500 lum

================================================================================
11. NETHER WEAPONS
================================================================================

-------------------------------------------
TEST 11.1: Nether Weapons in Loot Tables
-------------------------------------------
‚ùå Cannot Test (requires nether weapon weenies WCID 999900000-999900089)

Once weenies created:
[ ] Kill mobs in loot tier zones
[ ] Verify nether weapons drop
[ ] Check drop rates: 13% (same as elemental variants)
[ ] Test all weapon types:
    - 24 Heavy Weapons
    - 19 Light Weapons
    - 22 Finesse Weapons
    - 12 Two-Handed Weapons
    - 3 Crossbows
    - 2 Atlatls
    - 7 Bows (heritage-specific)

[ ] Verify damage type is Nether (1024)
[ ] Verify "Corrupted [name]" naming

================================================================================
12. EDGE CASES & STRESS TESTING
================================================================================

-------------------------------------------
TEST 12.1: Concurrent Banking Operations
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Login two characters on same account
2. Simultaneously deposit/withdraw from bank
3. Verify no race conditions

EXPECTED RESULTS:
- Operations serialized correctly
- No duplicate deposits/withdrawals
- Balances accurate

-------------------------------------------
TEST 12.2: Property Boundary Values
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Set Enlightenment to 99, 100, 101
2. Set negative values for currencies
3. Set extremely large values

EXPECTED RESULTS:
- ENL capped at 100
- Negative values handled gracefully
- No overflows

-------------------------------------------
TEST 12.3: Database Connectivity Loss
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Stop database server
2. Attempt banking operations
3. Attempt leaderboard queries

EXPECTED RESULTS:
- Graceful error handling
- No server crashes
- Error messages to player

================================================================================
13. COMMANDS SUMMARY CHECKLIST
================================================================================

Player Commands Implemented:
[ ] /qb - Quest Bonus display
[ ] /bonus - Quest Bonus display (alias)
[ ] /aug - Conquest custom augmentation levels display
[ ] /augs - Conquest custom augmentation levels display (alias)
[ ] /top qb - Quest Bonus leaderboard
[ ] /top level - Level leaderboard
[ ] /top enl - Enlightenment leaderboard
[ ] /top bank - Banked pyreals leaderboard
[ ] /top lum - Banked luminance leaderboard
[ ] /top augs - Total augmentations leaderboard
[ ] /bank or /b - Banking commands
  [ ] /b b - Balance
  [ ] /b d - Deposit all
  [ ] /b d p [amt] - Deposit pyreals
  [ ] /b d l [amt] - Deposit luminance
  [ ] /b d e [amt] - Deposit event tokens
  [ ] /b w p [amt] - Withdraw pyreals
  [ ] /b w l [amt] - Withdraw luminance
  [ ] /b w e [amt] - Withdraw event tokens
  [ ] /b t p [amt] [name] - Transfer pyreals
  [ ] /b t l [amt] [name] - Transfer luminance
  [ ] /b t e [amt] [name] - Transfer event tokens
[ ] /pk - PK status toggle
  [ ] /pk (no params) - Check status
  [ ] /pk on - Enable PK (requires confirm)
  [ ] /pk on confirm - Confirm PK enable
  [ ] /pk off - Disable PK

================================================================================
14. TESTING PRIORITY MATRIX
================================================================================

HIGH PRIORITY (Test Immediately):
1. All player commands (/qb, /aug, /bank, /top, /pk)
2. ENL system (cap, bonuses)
3. QB system (tracking, bonuses)
4. Banking (deposit, withdraw, transfer)
5. PK flagging (restrictions, timers)
6. Character limits (marketplace exemption)

MEDIUM PRIORITY (Test After Setup):
1. Leaderboards (requires stored procedures)
2. Tinkering to 20x
3. No item loss on PK death

LOW PRIORITY (Content Work Required):
1. Soul Fragment drops
2. PK dungeon bonuses
3. Nether weapons
4. Augmentation gems
5. VPN detection

CANNOT TEST (Weenies Not Created):
1. Event Tokens (Dragon Coins WCID 13370002)
2. Soul Fragments (WCID 999999998)
3. Nether Weapons (WCIDs 999900000-999900089)
4. Augmentation Gems (+1 and +5 variants)

================================================================================
15. BUG REPORTING TEMPLATE
================================================================================

When reporting issues, include:

ISSUE TITLE: [Brief description]

SEVERITY:
[ ] Critical - Server crash or data loss
[ ] High - Feature broken, impacts gameplay
[ ] Medium - Feature partially working
[ ] Low - Minor issue, cosmetic

STEPS TO REPRODUCE:
1.
2.
3.

EXPECTED RESULT:


ACTUAL RESULT:


ENVIRONMENT:
- Server Version:
- Database Version:
- Character Level:
- Admin/Player Account:

ADDITIONAL INFO:
- Server logs:
- Error messages:
- Screenshots:

================================================================================
16. DISCORD INTEGRATION
================================================================================

-------------------------------------------
TEST 16.1: Discord Chat Relay (Game ‚Üí Discord)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Discord bot configured and connected
- Access to Discord server channels
- GeneralChannelId and TradeChannelId configured in Config.js

TEST STEPS:
1. Type `/cg Hello from game!` in-game
2. Type `/trade Trading test!` in-game
3. Check Discord General channel for first message
4. Check Discord Trade channel for second message

EXPECTED RESULTS:
- `/cg` messages appear in Discord General channel
- `/trade` messages appear in Discord Trade channel
- Player name is shown before the message
- Message format: "PlayerName : Message"

PASS CRITERIA:
‚úì Messages appear in correct Discord channels
‚úì Player name is displayed correctly
‚úì Message content is accurate
‚úì No errors in server logs

-------------------------------------------
TEST 16.2: Discord Chat Relay (Discord ‚Üí Game)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Discord bot connected
- In-game character logged in

TEST STEPS:
1. Send message in Discord General channel
2. Send message in Discord Trade channel
3. Verify messages appear in-game

EXPECTED RESULTS:
- Discord General messages appear in-game General chat
- Discord Trade messages appear in-game Trade chat
- Discord username is shown
- Bot messages are ignored

PASS CRITERIA:
‚úì Bi-directional communication works
‚úì Messages sync in real-time
‚úì Discord nicknames display correctly

-------------------------------------------
TEST 16.3: Admin Audit Channel
-------------------------------------------
üîß Admin Tools Required

PREREQUISITES:
- Admin account
- AdminAuditId configured
- Access to Discord admin audit channel

TEST STEPS:
1. Use `@world open` command
2. Use `@world close` command
3. Use `@export-discord 1` command
4. Use `@import-discord test` command
5. Check Discord Admin Audit channel

EXPECTED RESULTS:
- "World is now open" appears in audit channel
- "World is now closed" appears in audit channel
- "Exported weenie X to Discord" appears
- "Imported 'test' from Discord" appears
- System or admin name shown

PASS CRITERIA:
‚úì All admin actions logged to audit channel
‚úì Correct attribution (admin name or System)

-------------------------------------------
TEST 16.4: Server Events Channel
-------------------------------------------
üîß Admin Tools Required

PREREQUISITES:
- EventsChannelId configured
- Admin account

TEST STEPS:
1. Use `@world open`
2. Use `@world close`
3. Use `@world close boot`
4. Use `@shutdown 5m`
5. Check Discord Events channel

EXPECTED RESULTS:
- World open: "üåç **World is now OPEN** - Players can now enter the world!"
- World close: "üîí **World is now CLOSED** - No new players can enter."
- World close boot: "üîí **World is now CLOSED** - All players have been booted."
- Shutdown 5m: "üì¢ **ATTENTION** - Server will shut down in 5 minutes."
- Shutdown 1m: "‚ö†Ô∏è **WARNING** - Server shutting down in X seconds! Please log out!"
- Shutdown now: "üî¥ **SERVER SHUTTING DOWN NOW!**"

PASS CRITERIA:
‚úì All events appear in Events channel
‚úì Correct emoji and formatting
‚úì Timing messages accurate

-------------------------------------------
TEST 16.5: Export to Discord
-------------------------------------------
üîß Admin Tools Required

PREREQUISITES:
- ExportsChannelId configured
- Admin account
- Existing weenie/recipe/quest/spell in database

TEST STEPS:
1. Use `@export-discord 1` (weenie)
2. Use `@export-discord 1 recipe` (recipe)
3. Use `@export-discord questname quest`
4. Use `@export-discord 1 spell`
5. Use `@export-discord A9B4 landblock`
6. Check Discord Exports channel

EXPECTED RESULTS:
- SQL file attached to Discord message
- Filename matches ID (e.g., "1.sql", "A9B4.sql")
- Player name shown in message
- Export message: "Exported weenie 1"
- File contains DELETE and INSERT statements

PASS CRITERIA:
‚úì SQL files upload successfully
‚úì Correct filename and content
‚úì All content types work (weenie, recipe, quest, spell, landblock)
‚úì Audit log shows export action

-------------------------------------------
TEST 16.6: Import from Discord
-------------------------------------------
üîß Admin Tools Required

PREREQUISITES:
- WeenieUploadsChannelId configured
- SQL file uploaded to Discord WeenieUploads channel
- Admin account

TEST STEPS:
1. Upload SQL file to Discord WeenieUploads channel (filename: "test.sql")
2. Use `@import-discord test` in-game
3. Verify import success message
4. Check database for imported content

EXPECTED RESULTS:
- Command finds SQL file in Discord channel
- Imports SQL to database
- Shows "Imported 'test' from Discord."
- Audit log shows import action
- Database contains new content

PASS CRITERIA:
‚úì Finds SQL files by identifier
‚úì Executes SQL successfully
‚úì Audit log created
‚úì Error handling if file not found

-------------------------------------------
TEST 16.7: Clothing Export/Import
-------------------------------------------
üîß Admin Tools Required (Optional - if clothing modding used)

PREREQUISITES:
- ClothingBase ID known (0x10000000 - 0x10FFFFFF range)
- ExportsChannelId configured

TEST STEPS:
1. Use `@export-discord-clothing 268435456` (0x10000000 in decimal)
2. Check Discord Exports channel for JSON file
3. Upload modified JSON to Discord
4. Use `@import-discord-clothing filename`

EXPECTED RESULTS:
- Export: JSON file uploaded with ClothingBase data
- Import: JSON saved to ModsDirectory/Clothing folder
- File format: {ClothingBaseId}.json

PASS CRITERIA:
‚úì ClothingBase exported as JSON
‚úì JSON import saves to correct folder

-------------------------------------------
TEST 16.8: Error Handling
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Try `@export-discord 999999999` (non-existent weenie)
2. Try `@import-discord nonexistent` (file not in Discord)
3. Send chat while Discord bot disconnected
4. Check server logs for graceful error handling

EXPECTED RESULTS:
- Export error: "Couldn't find weenie 999999999"
- Import error: "Couldn't find SQL attachment for 'nonexistent'"
- Chat errors: Warning logged, no crash
- Logs show connection state

PASS CRITERIA:
‚úì No server crashes
‚úì Clear error messages to user
‚úì Logs errors appropriately

================================================================================
17. DISCORD RESTART BOT (Windows VM Management)
================================================================================

-------------------------------------------
TEST 17.1: Bot Connection and Startup
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- DiscordRestartBot.exe deployed to VM
- config.json configured with correct Discord token and channel IDs
- ConquestBot.ico in same directory
- Bot invited to Discord server with proper permissions

TEST STEPS:
1. Run DiscordRestartBot.exe on Windows VM
2. Check system tray for "Conquest ACE Bot Running" icon
3. Verify Discord bot shows as online in server member list
4. Check console output for connection confirmation

EXPECTED RESULTS:
- Bot connects to Discord successfully
- System tray icon appears
- Console shows: "[Bot] Waiting for Discord connection..."
- Console shows: "Gateway Connecting" followed by successful connection
- No 401 Unauthorized errors

VERIFICATION:
- Bot token must be valid (regenerate if expired)
- config.json must have no trailing commas
- Bot has correct gateway intents (AllUnprivileged | MessageContent)

PASS CRITERIA:
‚úì Bot connects without errors
‚úì System tray icon visible
‚úì Bot shows online in Discord
‚úì No connection errors in console

-------------------------------------------
TEST 17.2: Server Start Command
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Server currently stopped
- User is authorized (in AuthorizedUserIds list)
- Server executable path correct in config.json

TEST STEPS:
1. In Discord command channel, type: startserver
2. Observe Discord bot response
3. Check for ACE.Server.exe console window appearing
4. Wait 2 seconds for startup

EXPECTED RESULTS:
- Message: "‚ñ∂Ô∏è Starting Conquest ACE server..."
- Message: "‚úÖ Server started successfully."
- ACE.Server.exe console window appears
- Server begins startup process

VERIFICATION:
- Check Task Manager for ACE.Server.exe process
- Console window should be visible (CreateNoWindow = false)
- StandardInput redirected (allows console commands)
- StandardOutput/Error NOT redirected (visible in console)

PASS CRITERIA:
‚úì Server process starts
‚úì Console window visible
‚úì Discord confirmation messages appear
‚úì Process tracked in bot memory

-------------------------------------------
TEST 17.3: Server Stop Command (Graceful Shutdown)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Server currently running
- User authorized

TEST STEPS:
1. Type: stopserver
2. Observe Discord messages
3. Watch server console for shutdown sequence
4. Verify process terminates

EXPECTED RESULTS:
1. Message: "üõë Stopping Conquest ACE server..."
2. Message: "‚è≥ Sending graceful shutdown command (stop-now)..."
3. Bot sends "stop-now" to server console
4. Server shuts down gracefully within 30 seconds
5. Message: "‚úÖ Server stopped gracefully."

GRACEFUL SHUTDOWN VERIFICATION:
- Bot sends "stop-now" via StandardInput.WriteLineAsync
- Server receives command and initiates shutdown
- Database saves all pending changes
- Players gracefully disconnected
- Process exits with code 0

TIMEOUT SCENARIO:
- If server doesn't exit in 30 seconds:
- Message: "‚ö†Ô∏è Graceful shutdown timed out, forcing stop..."
- Bot calls Process.Kill()
- Message: "‚úÖ Server stopped (forced)."

PASS CRITERIA:
‚úì Graceful shutdown attempted first
‚úì 30-second timeout enforced
‚úì Force kill as fallback
‚úì Process reference cleared

-------------------------------------------
TEST 17.4: Server Restart Command
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Server running or stopped
- User authorized

TEST STEPS:
1. Type: restartserver
2. Observe full restart sequence

EXPECTED RESULTS:
1. Message: "üîÅ Restarting Conquest ACE server..."
2. Graceful stop sequence (see TEST 17.3)
3. 3-second delay between stop and start
4. Start sequence (see TEST 17.2)
5. Admin log: "üõ†Ô∏è `Username` restarted the server at `timestamp` UTC."

VERIFICATION:
- RestartServer calls StopServer, waits 3 seconds, calls StartServer
- Admin log posted to AdminLogChannelId
- Username and timestamp included

PASS CRITERIA:
‚úì Full stop-wait-start sequence
‚úì Admin audit log created
‚úì Server comes back online

-------------------------------------------
TEST 17.5: Server Status Command
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. With server running, type: status
2. With server stopped, type: status

EXPECTED RESULTS - Running:
- "üìä üü¢ Server is **ONLINE** | Uptime: `Xd Xh Xm`"
- Uptime calculated from Process.StartTime

EXPECTED RESULTS - Stopped:
- "üìä üî¥ Server is **OFFLINE**"

PASS CRITERIA:
‚úì Accurate status reporting
‚úì Uptime calculation correct
‚úì Emoji indicators work

-------------------------------------------
TEST 17.6: Log Monitoring (Crash Detection)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- LogFilePath configured correctly
- CrashLogChannelId set in config.json
- Server generating logs

TEST STEPS:
1. Start server (log monitoring begins automatically)
2. Wait for "World is now open" in logs
3. Cause a crash (or simulate with test log entries)
4. Check Discord CrashLogChannelId channel

CRASH DETECTION TRIGGERS:
- "NullReferenceException"
- "Unhandled exception"
- "AggregateException"
- "System.Exception"

EXPECTED RESULTS:
1. Bot reads ACE_Log.txt in real-time
2. Detects crash pattern
3. Collects up to 100 lines or until "End of stack trace"
4. Analyzes severity (see severity matrix below)
5. Posts to Discord CrashLogChannelId:
   - Severity header (üî¥ CRITICAL or üü° Likely Recoverable)
   - Full stack trace in code blocks (chunked to 1900 chars)

SEVERITY ANALYSIS MATRIX:
- Database/MySQL/Connection ‚Üí "üî¥ CRITICAL CRASH - Database Issue"
- OutOfMemoryException ‚Üí "üî¥ CRITICAL CRASH - Out of Memory"
- StackOverflowException ‚Üí "üî¥ CRITICAL CRASH - Stack Overflow"
- LootGenerationFactory/MutateMeleeWeapon ‚Üí "üü° Likely Recoverable - Loot Generation Error"
- NullReferenceException ‚Üí "üü° Likely Recoverable - Null Reference"
- Default ‚Üí "‚ö†Ô∏è Server Crash Detected"

VERIFICATION:
- Check server logs for: "[LogMonitor] Crash detected: ..."
- Discord message includes full stack trace
- hasServerStarted flag resets after crash (waits for next "World is now open")

PASS CRITERIA:
‚úì Real-time log tailing works
‚úì Crash detection accurate
‚úì Severity classification correct
‚úì Full stack trace posted to Discord

-------------------------------------------
TEST 17.7: Error Batching (WARN/ERROR Messages)
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- ErrorLogChannelId configured
- Server generating WARN/ERROR messages

TEST STEPS:
1. Let server run and generate WARN/ERROR messages
2. Wait 60 seconds
3. Check Discord ErrorLogChannelId channel

EXPECTED RESULTS:
- Every 60 seconds, bot sends error summary
- Message format:
  "üìä **Error Summary (Last 60 seconds)**

  üî¥ `ErrorType1` - **X** occurrence(s)
  üü° `WarningType1` - **Y** occurrence(s)

  **Total:** Z WARN/ERROR messages"

ERROR EXTRACTION:
- Regex matches: Exception types, class names, method names
- Groups errors by type
- Shows top 10 error types by count
- Sorted by occurrence count (descending)

IN-MEMORY BATCH STRUCTURE:
- List<LogEntry> with Timestamp, Level, Message
- Cleared after every batch send (no disk bloat)
- Thread-safe with lock(errorLock)

PASS CRITERIA:
‚úì Errors batched in memory
‚úì 60-second interval enforced
‚úì Top 10 error types shown
‚úì Memory cleared after send
‚úì No disk writes

-------------------------------------------
TEST 17.8: Authorization Checks
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two Discord users: one authorized, one not
- AuthorizedUserIds list in config.json

TEST STEPS:
1. Unauthorized user types: restartserver
2. Unauthorized user types: stopserver
3. Unauthorized user types: startserver
4. Unauthorized user types: status
5. Authorized user types: restartserver

EXPECTED RESULTS:
1-3. Message: "‚ùå You are not authorized to use this command."
4. Status command works for everyone
5. Restart command executes

VERIFICATION:
- Check config.json AuthorizedUserIds array
- User IDs are ulong Discord user IDs

PASS CRITERIA:
‚úì Unauthorized users blocked from server control
‚úì Status command public
‚úì Authorized users have full access

-------------------------------------------
TEST 17.9: Edge Cases and Error Handling
-------------------------------------------
‚úÖ Can Test Now

TEST CASES:

1. Start server when already running:
   - Expected: "‚ö†Ô∏è Server is already running."

2. Stop server when already stopped:
   - Expected: "‚ö†Ô∏è Server process is not running."

3. Server executable path doesn't exist:
   - Expected: "‚ùå Failed to start server process."

4. Log file doesn't exist:
   - Console: "[LogMonitor] Log file not found: ..."
   - No crash, continues running

5. Discord channel ID invalid:
   - Console: "[LogMonitor] Could not locate crash Discord channel."
   - No crash, continues running

6. Server crashes during startup:
   - Bot detects crash and posts to Discord
   - hasServerStarted flag prevents false crash reports

PASS CRITERIA:
‚úì All edge cases handled gracefully
‚úì No bot crashes
‚úì Clear error messages
‚úì Bot remains running despite errors

-------------------------------------------
TEST 17.10: System Tray Icon and Exit
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Locate bot icon in Windows system tray
2. Hover over icon
3. Right-click icon
4. Select "Exit"

EXPECTED RESULTS:
- Tooltip: "Conquest ACE Bot Running"
- Custom icon (ConquestBot.ico) if file exists
- Default icon (SystemIcons.Information) if file missing
- Context menu shows "Exit" option
- Clicking Exit: tray icon disappears, process terminates

PASS CRITERIA:
‚úì Custom icon loads correctly
‚úì Fallback icon works
‚úì Exit menu functions
‚úì Process terminates cleanly

================================================================================
18. FELLOWSHIP COMMAND SYSTEM
================================================================================

-------------------------------------------
TEST 18.1: Fellowship Creation
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two or more player characters
- Not in Marketplace (landblock 0x016C blocked for mass invites)

TEST STEPS:
1. Type `/fship` (no parameters)
2. Type `/fship create MyTestFellowship`
3. Verify fellowship created

EXPECTED RESULTS:
1. Help message showing all available commands:
   - /fship add <name or targeted player>
   - /fship landblock
   - /fship remove <name or targeted player>
   - /fship create <name>
   - /fship leave
   - /fship disband
2. Fellowship created successfully
3. Leader assigned to creator

PASS CRITERIA:
‚úì Help message displays all commands
‚úì Fellowship created with custom name
‚úì Creator is fellowship leader

-------------------------------------------
TEST 18.2: Add/Remove Players
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Fellowship created
- Second player character available

TEST STEPS - Add by Name:
1. Type `/fship add PlayerName`
2. Target player receives fellowship invite
3. Player accepts invite

TEST STEPS - Add by Target:
1. Target player with selection
2. Type `/fship add`
3. Player receives invite and accepts

TEST STEPS - Remove Player:
1. Type `/fship remove PlayerName` or target and `/fship remove`
2. Verify player removed from fellowship

EXPECTED RESULTS:
- Fellowship invite sent to target
- Player can accept/decline
- Removed players leave fellowship
- Fellowship updates for all members

PASS CRITERIA:
‚úì Add by name works
‚úì Add by target works
‚úì Remove by name works
‚úì Remove by target works
‚úì Fellowship updates properly

-------------------------------------------
TEST 18.3: Landblock Mass Invite
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Multiple players in same landblock
- NOT in Marketplace (blocked)
- Fellowship leader ‚â• level 50 (for level restriction test)

TEST STEPS:
1. Leader types `/fship landblock`
2. Verify all eligible players receive invites

ELIGIBILITY RULES:
- Not the leader themselves
- Not flagged as mule (IsMule = false)
- Not admin/cloaked (CloakStatus = Player, Off, or Undef)
- Not squelched by leader
- Level restriction: If leader is ‚â•50, only invite players ‚â•50

MARKETPLACE BLOCK:
1. Go to Marketplace (landblock 0x016C)
2. Type `/fship landblock`
3. Expected: "[FSHIP]: Your current landblock is in the Marketplace, and cannot be used to form landblock fellowships"

PASS CRITERIA:
‚úì All eligible players invited
‚úì Mules excluded
‚úì Admins excluded
‚úì Squelched players excluded
‚úì Level restriction enforced (if leader ‚â•50)
‚úì Marketplace blocked

-------------------------------------------
TEST 18.4: Leave and Disband
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS - Leave:
1. Fellowship member types `/fship leave`
2. Verify member removed from fellowship
3. Fellowship continues for remaining members

TEST STEPS - Disband:
1. Fellowship leader types `/fship disband`
2. Verify entire fellowship disbanded
3. All members removed

EXPECTED RESULTS:
- Leave: Only caller removed, fellowship continues
- Disband: Entire fellowship dissolved

PASS CRITERIA:
‚úì Leave removes only the player
‚úì Disband removes all members
‚úì Non-leaders cannot disband
‚úì Fellowship updates sent to all members

================================================================================
19. NEW EMOTE TYPES (Content Creation)
================================================================================

-------------------------------------------
TEST 19.1: IncrementInt64Stat / DecrementInt64Stat
-------------------------------------------
‚ùå Cannot Test (requires weenie/NPC with emotes)

EMOTE TYPE: 125 (IncrementInt64Stat), 124 (DecrementInt64Stat)

Once NPC/quest with these emotes exists:
[ ] Create NPC with IncrementInt64Stat emote
[ ] Set emote.Stat to PropertyInt64 ID (e.g., 9027 for DailySoulFragmentCount)
[ ] Set emote.Amount to increment/decrement value
[ ] Trigger emote (talk to NPC, use item, etc.)
[ ] Verify PropertyInt64 value incremented/decremented correctly
[ ] Check database character_properties_int64 table

USAGE EXAMPLES:
- Track custom counters (daily limits, progression, etc.)
- Increment quest stages
- Decrement resource pools

PASS CRITERIA:
‚úì PropertyInt64 value changes correctly
‚úì Database persists changes
‚úì Amount defaults to 1 if not specified

-------------------------------------------
TEST 19.2: SetAttributeStat
-------------------------------------------
‚ùå Cannot Test (requires weenie/NPC with emotes)

EMOTE TYPE: SetAttributeStat

Once NPC exists:
[ ] Create NPC with SetAttributeStat emote
[ ] Set emote.Stat to attribute ID:
    1 = Strength
    2 = Endurance
    3 = Quickness
    4 = Coordination
    5 = Focus
    6 = Self
[ ] Set emote.Amount to target rank value
[ ] Trigger emote
[ ] Verify attribute Ranks set to specified value
[ ] Does NOT spend XP (uses CalcAttributeRank for XP cost lookup)

VERIFICATION:
- Check character stats panel
- Verify Ranks changed but ExperienceSpent unchanged

PASS CRITERIA:
‚úì Attribute ranks set to exact value
‚úì No XP spent
‚úì Stat updates sent to client
‚úì Invalid stat IDs ignored

-------------------------------------------
TEST 19.3: GrantAttributeStat
-------------------------------------------
‚ùå Cannot Test (requires weenie/NPC with emotes)

EMOTE TYPE: GrantAttributeStat

Once NPC exists:
[ ] Create NPC with GrantAttributeStat emote
[ ] Set emote.Stat to PropertyAttribute enum value (1-6)
[ ] Set emote.Amount to number of ranks to grant (default 1)
[ ] Trigger emote
[ ] Verify attribute StartingValue (InitLevel) increased
[ ] Check for advancement message: "Your base {attribute} has been increased by {amount}."

DIFFERENCE FROM SetAttributeStat:
- GrantAttributeStat: Permanently increases BASE/template value
- SetAttributeStat: Sets current Ranks to specific value

VERIFICATION:
- StartingValue increases (permanent boost)
- Endurance grants also update Health vital
- Self grants also update Mana vital

PASS CRITERIA:
‚úì StartingValue increased permanently
‚úì No XP cost
‚úì Advancement message shown
‚úì Related vitals updated (Endurance‚ÜíHealth, Self‚ÜíMana)
‚úì Invalid attributes rejected with log warning

-------------------------------------------
TEST 19.4: GrantVitalStat
-------------------------------------------
‚ùå Cannot Test (requires weenie/NPC with emotes)

EMOTE TYPE: GrantVitalStat

Once NPC exists:
[ ] Create NPC with GrantVitalStat emote
[ ] Set emote.Stat to PropertyAttribute2nd value:
    1 = MaxHealth
    3 = MaxStamina
    5 = MaxMana
[ ] Set emote.Amount to number of ranks to grant
[ ] Trigger emote
[ ] Verify vital StartingValue increased
[ ] Check advancement message: "Your base {vital} has been increased by {amount}."

SUPPORTED VITALS ONLY:
- MaxHealth, MaxStamina, MaxMana
- Other vitals (CurrentHealth, etc.) rejected with log warning

PASS CRITERIA:
‚úì Vital StartingValue increased
‚úì No XP cost
‚úì Advancement message shown
‚úì Unsupported vitals rejected
‚úì Invalid vital IDs logged

-------------------------------------------
TEST 19.5: SetEnvironment (Fog and Sound Effects)
-------------------------------------------
‚ùå Cannot Test (requires weenie/NPC with emotes)

EMOTE TYPE: SetEnvironment

Once NPC exists:
[ ] Create NPC/trigger with SetEnvironment emote
[ ] Set emote.Amount to effect type:

FOG EFFECTS (0-6):
  0 = Clear (remove effects)
  1 = Red Fog
  2 = Blue Fog
  3 = White Fog
  4 = Green Fog
  5 = Black Fog
  6 = Black Fog 2

SOUND EFFECTS (101-111+):
  101 = Roar Sound
  102 = Bell Sound
  103 = Chant 1 Sound
  104 = Chant 2 Sound
  105 = Dark Whispers 1 Sound
  106 = Dark Whispers 2 Sound
  107 = Dark Laugh Sound
  108 = Dark Wind Sound
  109 = Dark Speech Sound
  110 = Drums Sound
  111+ = Additional sounds (check EmoteManager.cs for full list)

[ ] Trigger emote
[ ] Verify environmental effect applied to entire landblock
[ ] All players in landblock see/hear effect

USAGE EXAMPLES:
- Boss enrage triggers red fog and roar sound
- Ritual completion triggers chanting and fog
- Dungeon atmosphere changes based on events

PASS CRITERIA:
‚úì Fog effects visible to all players in landblock
‚úì Sound effects audible to all players
‚úì Effects clear when Amount = 0
‚úì No effect if WorldObject or CurrentLandblock is null

================================================================================
20. ENRAGE SYSTEM (FULLY IMPLEMENTED)
================================================================================

CURRENT STATUS: ‚úÖ Fully Implemented - All mechanics active and ready for testing

IMPLEMENTATION SUMMARY:
- Boss health monitoring with configurable thresholds
- 2x damage output when enraged (configurable)
- 20% damage reduction when enraged (configurable)
- Visual/Audio/Fog environmental effects
- Grapple mechanic - teleports random players to boss every 8-12 seconds
- AOE Hotspot mechanic - spawns damage zones at player locations every 10-15 seconds
- Enraged hotspots with 3x-7x collision detection radius
- Death cleanup - cancels async loops and resets fog

-------------------------------------------
TEST 20.1: Basic Enrage Trigger
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (boss weenie with enrage properties)

PREREQUISITES:
- Boss creature with CanEnrage = true
- EnrageThreshold set (default 0.2 = 20% HP)
- Admin account to set properties

SETUP STEPS:
1. Create or modify boss creature weenie
2. Set PropertyBool.CanEnrage = true (9014)
3. Set PropertyFloat.EnrageThreshold = 0.2 (9013) [20% HP]
4. Optional: Set PropertyFloat.EnrageDamageMultiplier = 2.0 (9011)
5. Optional: Set PropertyFloat.EnrageDamageReduction = 0.2 (9012) [20% reduction]
6. Optional: Set PropertyInt.EnrageFogColor = 1 (9025) [Red fog]
7. Optional: Set PropertyInt.EnrageSound = 101 (9026) [Roar sound]
8. Optional: Set PropertyInt.EnrageVisualEffect = [effect ID] (9027)

TEST STEPS:
1. Spawn boss creature
2. Engage boss in combat
3. Damage boss to exactly 21% HP (above threshold)
4. Damage boss to 19% HP (below threshold)
5. Observe enrage activation

EXPECTED RESULTS:
- Boss does NOT enrage at 21% HP
- Boss DOES enrage at 19% HP
- Broadcast message: "[Boss Name] becomes enraged and starts attacking fiercely!"
- Environmental effects apply (fog, sound, visual if configured)
- Boss deals increased damage (2x by default)
- Boss takes reduced damage (20% reduction by default)

VERIFICATION:
- Check IsEnraged property on creature (should be true)
- Verify fog effect visible to all players in landblock
- Verify sound effect audible to all players
- Test damage output before and after enrage (should double)
- Test damage intake before and after enrage (should be reduced by 20%)

EDGE CASES:
[ ] Enrage triggers from melee damage
[ ] Enrage triggers from missile damage
[ ] Enrage triggers from magic damage
[ ] Multiple players attacking simultaneously
[ ] Boss healed above threshold (stays enraged until death)
[ ] Boss dies while enraged (fog clears, loops cancel)

PASS CRITERIA:
‚úì Enrage triggers at correct HP threshold
‚úì Environmental effects apply correctly
‚úì Damage multiplier and reduction work
‚úì Broadcast message appears
‚úì Only triggers once per creature life

-------------------------------------------
TEST 20.2: Grapple Mechanic (CanGrapple)
-------------------------------------------
‚ö†Ô∏è Requires Content Creation + CanGrapple enabled

PREREQUISITES:
- Boss with CanEnrage = true and CanGrapple = true
- Multiple players for randomized teleport testing
- Boss enraged (triggered enrage first)

SETUP STEPS:
1. Set PropertyBool.CanGrapple = true (9015) on boss
2. Ensure boss can enrage (see TEST 20.1)
3. Have 2-3 players in range of boss (within 250m)

TEST STEPS:
1. Trigger boss enrage (damage below threshold)
2. Wait 5 seconds for initial grapple delay
3. Observe grapple loop behavior
4. Multiple players should take turns being grappled

EXPECTED RESULTS:
1. 5-second delay after enrage before first grapple
2. Boss broadcasts: "[Boss Name] Lashes out, attempting to drag his next victim closer!"
3. 2.5 seconds later, random player teleported to boss location
4. Boss broadcasts: "Get Over Here [Player Name]!"
5. Boss switches attack target to grappled player
6. 6-second delay before boss can switch targets again
7. After 30 seconds, another player is grappled
8. Loop continues until boss dies

GRAPPLE SELECTION LOGIC:
- Selects random player within 250m range
- Excludes last hotspot target (if CanAOE enabled)
- If only 1 player in range, always grapples that player
- If multiple players, randomizes selection

VERIFICATION:
- Check grappleLoopTask running on creature
- Verify grappleLoopCTS (cancellation token) active
- Verify players teleported to boss location
- Verify boss target switches to grappled player
- Verify 30-second cooldown between grapples

EDGE CASES:
[ ] Grapple with only 1 player in range
[ ] Grapple with 5+ players in range
[ ] Player dies during grapple (boss should select new target)
[ ] Player logs out during grapple
[ ] Boss dies mid-grapple (loop should cancel)

PASS CRITERIA:
‚úì Grapple loop starts 5 seconds after enrage
‚úì Random player selection works
‚úì Teleport to boss location accurate
‚úì Boss switches targets correctly
‚úì 30-second cooldown enforced
‚úì Loop cancels on boss death

-------------------------------------------
TEST 20.3: AOE Hotspot Spawning (CanAOE)
-------------------------------------------
‚ö†Ô∏è Requires Content Creation + Hotspot Weenies (90000411-90000417)

PREREQUISITES:
- Boss with CanEnrage = true and CanAOE = true
- Hotspot weenies created (WCIDs 90000411-90000417):
  * 90000411 (damage) + 91000411 (visual) - Acid pool
  * 90000412 (damage) + 91000412 (visual) - Fire burst
  * 90000413 (damage) + 91000413 (visual) - Frost
  * 90000414 (damage) + 91000414 (visual) - Lightning
  * 90000415 (damage) + 91000415 (visual) - Sandstorm
  * 90000416 (damage) + 91000416 (visual) - Void
  * 90000417 (visual only) - Iron cage trap
- Multiple players for testing

SETUP STEPS:
1. Set PropertyBool.CanAOE = true (9016) on boss
2. Ensure hotspot weenies exist in database
3. Set PropertyBool.EnragedHotspot = true (9017) on hotspot weenies
4. Have 2-3 players in range of boss

TEST STEPS:
1. Trigger boss enrage
2. Wait 5 seconds for initial hotspot delay
3. Observe hotspot spawning at player locations
4. Wait 10-15 seconds for next hotspot
5. Verify cycle continues until boss dies

EXPECTED RESULTS:
1. 5-second delay after enrage before first hotspot
2. Boss selects random player location
3. Hotspot spawns at player's feet
4. Broadcast: "The enraged mob targets [Player Name]! [Hotspot-specific message]"
5. Hotspot persists for 20 seconds
6. Both damage and visual objects spawn
7. 10-15 second random delay before next hotspot
8. Loop continues until boss dies

HOTSPOT MESSAGES:
- Acid: "A searing pool of acid forms at their location, better run away!"
- Fire: "Fire bursts at their feet, move quickly!"
- Frost: "A chilling frost gathers, flee to avoid being frozen!"
- Lightning: "A shocking vortex opens, get out of its pull!"
- Sandstorm: "A Sandstorm stirs up, move now or be torn to shreds!"
- Void: "A void emerges from the ground, quickly escape or wither away!"
- Iron Cage: "An iron cage falls from the sky, dodge it or be trapped!"

ENRAGED HOTSPOT PHYSICS:
- Normal hotspots: Standard collision detection
- Enraged hotspots: 3x radius for CylSphere, 7x radius for Sphere
- Players hit from much farther away than normal hotspots
- Increased danger zone for boss mechanics

VERIFICATION:
- Check hotspotLoopTask running on creature
- Check hotspotLoopCTS active
- Verify hotspot objects spawn at player location
- Verify 20-second despawn timer
- Verify both damage and visual objects spawn (except cage - visual only)
- Verify EnragedHotspot property set on spawned hotspots
- Test enlarged collision detection (stand farther away and still get hit)

EDGE CASES:
[ ] Hotspot spawns with only 1 player
[ ] Hotspot spawns with 5+ players
[ ] Player moves before hotspot spawns
[ ] Boss dies mid-hotspot (hotspots should remain for 20s)
[ ] Multiple hotspots active simultaneously

PASS CRITERIA:
‚úì Hotspot loop starts 5 seconds after enrage
‚úì Random hotspot type selection works
‚úì Spawn location matches player position
‚úì 20-second despawn timer works
‚úì 10-15 second random delay between spawns
‚úì Loop cancels on boss death
‚úì Enraged hotspot collision detection 3x-7x larger than normal
‚úì Players hit from extended range

-------------------------------------------
TEST 20.4: Enrage Damage Modifiers
-------------------------------------------
‚úÖ Can Test Now (requires enraged boss)

PREREQUISITES:
- Boss with CanEnrage = true
- EnrageDamageMultiplier set (default 2.0)
- EnrageDamageReduction set (default 0.2 = 20%)
- Combat logs or damage tracking enabled

TEST STEPS - Damage Output:
1. Record boss base damage before enrage
2. Trigger enrage
3. Record boss damage after enrage
4. Compare values

EXPECTED RESULTS - Damage Output:
- Pre-enrage: Boss deals 100 damage (example)
- Post-enrage: Boss deals 200 damage (2x multiplier)
- Applied to both base damage and critical damage
- Works for melee, missile, and magic attacks

TEST STEPS - Damage Intake:
1. Deal 100 damage to boss before enrage
2. Note damage number
3. Trigger enrage
4. Deal same attack to boss after enrage
5. Compare damage numbers

EXPECTED RESULTS - Damage Intake:
- Pre-enrage: Boss takes 100 damage (example)
- Post-enrage: Boss takes 80 damage (20% reduction)
- Applied after all other mitigation calculations
- Works for all damage types

FORMULA BREAKDOWN:
- Outgoing Damage = Base Damage √ó EnrageDamageMultiplier (default 2.0)
- Incoming Damage = Final Damage √ó (1.0 - EnrageDamageReduction) (default 0.8)

VERIFICATION:
- Check DamageEvent.cs application of multipliers
- Verify BaseDamage modified by EnrageDamageMultiplier
- Verify CriticalDamageMod modified by EnrageDamageMultiplier
- Verify final Damage reduced by EnrageDamageReduction
- Confirm only applies to creatures with IsEnraged = true
- Confirm does NOT apply to players

EDGE CASES:
[ ] EnrageDamageMultiplier = 1.0 (no change)
[ ] EnrageDamageMultiplier = 5.0 (5x damage)
[ ] EnrageDamageReduction = 0.0 (no reduction)
[ ] EnrageDamageReduction = 0.99 (99% reduction)
[ ] Critical hits while enraged (should multiply crit damage too)

PASS CRITERIA:
‚úì Damage output scales correctly
‚úì Damage intake reduces correctly
‚úì Applies to all attack types
‚úì Only affects enraged creatures
‚úì Critical hits scaled correctly

-------------------------------------------
TEST 20.5: Enrage Visual/Audio Effects
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (effect IDs configured)

PREREQUISITES:
- Boss with CanEnrage = true
- EnrageFogColor, EnrageSound, EnrageVisualEffect configured

SETUP STEPS:
1. Set PropertyInt.EnrageFogColor = 1 (9025) [Red fog - see SetEnvironment values]
2. Set PropertyInt.EnrageSound = 101 (9026) [Roar sound - see SetEnvironment values]
3. Set PropertyInt.EnrageVisualEffect = [PlayScript ID] (9027)

FOG COLOR OPTIONS (matches SetEnvironment):
- 0 = Clear (no fog)
- 1 = Red Fog
- 2 = Blue Fog
- 3 = White Fog
- 4 = Green Fog
- 5 = Black Fog
- 6 = Black Fog 2

SOUND OPTIONS (matches SetEnvironment):
- 101 = Roar Sound
- 102 = Bell Sound
- 103 = Chant 1 Sound
- 104 = Chant 2 Sound
- 105 = Dark Whispers 1 Sound
- 106 = Dark Whispers 2 Sound
- 107 = Dark Laugh Sound
- 108 = Dark Wind Sound
- 109 = Dark Speech Sound
- 110 = Drums Sound
- 111+ = Additional sounds

TEST STEPS:
1. Trigger boss enrage
2. Observe environmental changes
3. Check fog visibility
4. Check sound audibility
5. Check visual effect display

EXPECTED RESULTS:
- Fog effect broadcasts to entire landblock
- Sound effect broadcasts to entire landblock
- Visual effect plays on boss creature
- All players in landblock see/hear effects
- Effects persist until boss death

VERIFICATION:
- Fog sent via CurrentLandblock.SendEnvironChange()
- Sound sent via CurrentLandblock.SendEnvironChange()
- Visual sent via GameMessageScript to boss
- Check ApplyEnrageEffects() method execution

EDGE CASES:
[ ] No fog configured (skip fog)
[ ] No sound configured (skip sound)
[ ] No visual configured (skip visual)
[ ] Multiple enraged bosses in same landblock
[ ] Boss dies (fog should clear to EnvironChangeType.Clear)

PASS CRITERIA:
‚úì Fog broadcasts to landblock
‚úì Sound broadcasts to landblock
‚úì Visual effect plays on boss
‚úì Effects visible/audible to all players
‚úì Fog clears on boss death

-------------------------------------------
TEST 20.6: Enrage Death Cleanup
-------------------------------------------
‚úÖ Can Test Now (requires enraged boss to die)

PREREQUISITES:
- Boss with CanEnrage = true
- Boss currently enraged with grapple/hotspot loops running

TEST STEPS:
1. Trigger boss enrage (activate grapple and/or hotspot loops)
2. Wait for loops to start (observe grapples/hotspots)
3. Kill boss
4. Observe cleanup behavior

EXPECTED RESULTS:
1. grappleLoopCTS?.Cancel() called
2. hotspotLoopCTS?.Cancel() called
3. Fog resets to Clear (EnvironChangeType.Clear)
4. No more grapples occur
5. No more hotspots spawn
6. Existing hotspots persist for their 20s duration
7. No errors in server logs

VERIFICATION:
- Check Creature_Death.cs OnDeath() method
- Verify cancellation tokens cancelled
- Verify fog reset only if IsEnraged = true
- Verify no exceptions from cancelled async tasks
- Check server console for "grapple loop terminated" or "hotspot loop terminated" (expected on cancel)

EDGE CASES:
[ ] Boss dies before first grapple/hotspot (should handle gracefully)
[ ] Boss dies mid-grapple animation
[ ] Boss dies mid-hotspot spawn
[ ] Multiple enraged bosses die simultaneously

PASS CRITERIA:
‚úì Cancellation tokens cancelled
‚úì Fog clears from landblock
‚úì No new grapples after death
‚úì No new hotspots after death
‚úì No server errors/crashes
‚úì Clean async task termination

================================================================================
21. PORTAL RESTRICTION SYSTEM (FULLY IMPLEMENTED)
================================================================================

CURRENT STATUS: ‚úÖ Fully Implemented - Custom portal restrictions ready for use

IMPLEMENTATION SUMMARY:
- Single enum design (optimized from ILT's dual-enum approach)
- Dual requirement support (primary + secondary with AND logic)
- Min/max range validation for all requirement types
- 5 requirement types: CreatureAug, ItemAug, LifeAug, Enlighten, QuestBonus
- Integrated into Portal.CheckUseRequirements() validation flow

-------------------------------------------
TEST 21.1: Creature Augmentation Requirement
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with CreatureAug requirement)

PREREQUISITES:
- Portal configured with PortalReqType = CreatureAug (1)
- Character with varying LuminanceAugmentCreatureCount levels
- Admin access to set augmentation values

SETUP STEPS:
1. Create or modify portal weenie
2. Set PropertyInt.PortalReqType = 1 (CreatureAug)
3. Set PropertyInt.PortalReqValue = 5 (min 5 creature augs)
4. Optional: Set PropertyInt.PortalReqMaxValue = 10 (max 10 creature augs)

TEST STEPS:
1. Set character LuminanceAugmentCreatureCount = 4
2. Attempt to use portal
3. Set character LuminanceAugmentCreatureCount = 5
4. Attempt to use portal
5. If max configured: Set LuminanceAugmentCreatureCount = 11
6. Attempt to use portal

EXPECTED RESULTS:
- 4 augs: Portal blocked with message "You must augment your creature magic 5 times to interact with that portal!"
- 5 augs: Portal entry succeeds
- 11 augs (if max configured): Portal blocked with message "You have augmented your creature magic more than 10 times and cannot interact with that portal!"

VERIFICATION:
- Check Portal.cs CheckPortalRequirement() method
- Verify player.LuminanceAugmentCreatureCount compared correctly
- Verify min/max range logic works

PASS CRITERIA:
‚úì Minimum requirement enforced
‚úì Maximum requirement enforced (if configured)
‚úì Appropriate error messages shown
‚úì Portal entry allowed when in range

-------------------------------------------
TEST 21.2: Item Augmentation Requirement
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with ItemAug requirement)

SETUP STEPS:
1. Set PropertyInt.PortalReqType = 2 (ItemAug)
2. Set PropertyInt.PortalReqValue = 3 (min 3 item augs)
3. Optional: Set PropertyInt.PortalReqMaxValue = 8 (max 8 item augs)

TEST STEPS:
1. Set character LuminanceAugmentItemCount = 2
2. Attempt portal entry (should fail)
3. Set character LuminanceAugmentItemCount = 5
4. Attempt portal entry (should succeed)

EXPECTED RESULTS:
- Error: "You must augment your item magic 3 times to interact with that portal!"
- Success: Portal entry allowed

PASS CRITERIA:
‚úì Item augmentation requirement validated
‚úì Error messages accurate
‚úì Min/max range checks work

-------------------------------------------
TEST 21.3: Life Augmentation Requirement
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with LifeAug requirement)

SETUP STEPS:
1. Set PropertyInt.PortalReqType = 3 (LifeAug)
2. Set PropertyInt.PortalReqValue = 2
3. Optional: Set PropertyInt.PortalReqMaxValue = 6

TEST STEPS:
Similar to CreatureAug and ItemAug tests

EXPECTED RESULTS:
- Error: "You must augment your life magic 2 times to interact with that portal!"
- Max error: "You have augmented your life magic more than 6 times and cannot interact with that portal!"

PASS CRITERIA:
‚úì Life augmentation validated correctly

-------------------------------------------
TEST 21.4: Enlightenment Requirement
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with Enlighten requirement)

SETUP STEPS:
1. Set PropertyInt.PortalReqType = 4 (Enlighten)
2. Set PropertyInt.PortalReqValue = 25 (min ENL 25)
3. Optional: Set PropertyInt.PortalReqMaxValue = 75 (max ENL 75)

TEST STEPS:
1. Set character Enlightenment = 20
2. Attempt portal entry
3. Set character Enlightenment = 50
4. Attempt portal entry
5. Set character Enlightenment = 80
6. Attempt portal entry (if max configured)

EXPECTED RESULTS:
- 20 ENL: "You must enlighten 25 times to interact with that portal!"
- 50 ENL: Portal entry succeeds
- 80 ENL: "You have enlightened more than 75 times and cannot interact with that portal!"

VERIFICATION:
- Check player.Enlightenment property (PropertyInt 390)
- Verify range validation

PASS CRITERIA:
‚úì Enlightenment requirement validated
‚úì Min/max logic works
‚úì Error messages accurate

-------------------------------------------
TEST 21.5: Quest Bonus Requirement
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with QuestBonus requirement)

SETUP STEPS:
1. Set PropertyInt.PortalReqType = 5 (QuestBonus)
2. Set PropertyInt.PortalReqValue = 100 (min 100 quests)
3. Optional: Set PropertyInt.PortalReqMaxValue = 500 (max 500 quests)

TEST STEPS:
1. Set character QuestCompletionCount = 50
2. Attempt portal entry
3. Set character QuestCompletionCount = 300
4. Attempt portal entry
5. Set character QuestCompletionCount = 600
6. Attempt portal entry (if max configured)

EXPECTED RESULTS:
- 50 quests: "You must have 100 quest bonus to interact with that portal!"
- 300 quests: Portal entry succeeds
- 600 quests: "Your quest bonus is too superior to interact with this portal. 500 is the highest quest bonus allowable!"

VERIFICATION:
- Check player.QuestCompletionCount property (PropertyInt64 9027)
- Verify comparison logic

PASS CRITERIA:
‚úì Quest bonus requirement validated
‚úì Min/max range checks work
‚úì Special max error message shown

-------------------------------------------
TEST 21.6: Dual Requirements (AND Logic)
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (portal with two requirements)

SETUP STEPS:
1. Set PropertyInt.PortalReqType = 1 (CreatureAug)
2. Set PropertyInt.PortalReqValue = 5
3. Set PropertyInt.PortalReqMaxValue = 10
4. Set PropertyInt.PortalReqType2 = 5 (QuestBonus)
5. Set PropertyInt.PortalReqValue2 = 100
6. Set PropertyInt.PortalReqMaxValue2 = 500

TEST STEPS:
1. Character with 7 CreatureAug, 50 QB - Attempt entry
2. Character with 3 CreatureAug, 200 QB - Attempt entry
3. Character with 7 CreatureAug, 200 QB - Attempt entry
4. Character with 11 CreatureAug, 200 QB - Attempt entry
5. Character with 7 CreatureAug, 600 QB - Attempt entry

EXPECTED RESULTS:
1. Fail - QB too low: "You must have 100 quest bonus to interact with that portal!"
2. Fail - CreatureAug too low: "You must augment your creature magic 5 times to interact with that portal!"
3. Success - Both requirements met
4. Fail - CreatureAug too high: "You have augmented your creature magic more than 10 times and cannot interact with that portal!"
5. Fail - QB too high: "Your quest bonus is too superior to interact with this portal. 500 is the highest quest bonus allowable!"

VERIFICATION:
- Both CheckPortalRequirement() calls execute
- AND logic: Both must pass for portal entry
- First failure returns immediately (short-circuit evaluation)

PASS CRITERIA:
‚úì Dual requirements validated
‚úì AND logic works (both must pass)
‚úì Appropriate error shown for first failure
‚úì Range checks work for both requirements

-------------------------------------------
TEST 21.7: IgnorePortalRestrictions Override
-------------------------------------------
‚úÖ Can Test Now (with admin account)

PREREQUISITES:
- Portal with any requirement configured
- Admin/sentinel account
- Character with IgnorePortalRestrictions property

TEST STEPS:
1. Set portal requirements that character doesn't meet
2. Set character IgnorePortalRestrictions = true
3. Attempt portal entry

EXPECTED RESULTS:
- Portal entry succeeds
- No requirement checks performed
- No error messages

VERIFICATION:
- Check Portal.cs line 164: if (!player.IgnorePortalRestrictions)
- Admin characters can bypass all custom restrictions
- Does NOT bypass built-in restrictions (level, PK status, etc.)

PASS CRITERIA:
‚úì IgnorePortalRestrictions bypasses custom requirements
‚úì Works for single requirements
‚úì Works for dual requirements

-------------------------------------------
TEST 21.8: Requirement Type None (No Restrictions)
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Create portal with PortalReqType = None (0)
2. Or leave PortalReqType unset
3. Attempt portal entry with any character

EXPECTED RESULTS:
- Portal entry succeeds
- No requirement validation performed
- Works like standard AC portal

VERIFICATION:
- Check Portal.cs line 245: if (PortalReqType != PortalRequirement.None && PortalReqValue.GetValueOrDefault() > 0)
- Validation only runs if Type is set AND Value > 0

PASS CRITERIA:
‚úì None requirement allows all players
‚úì Unset requirements allow all players
‚úì Value = 0 skips validation

-------------------------------------------
TEST 21.9: Edge Cases
-------------------------------------------
‚úÖ Can Test Now

TEST CASES:

1. PortalReqValue = 0 (no minimum):
   - Expected: Validation skipped, portal entry allowed

2. PortalReqMaxValue = 0 (no maximum):
   - Expected: Only minimum checked, no max enforcement

3. PortalReqMaxValue < PortalReqValue (invalid config):
   - Expected: Max check always fails if player > min
   - Recommendation: Content creators should avoid this

4. Secondary requirement without primary:
   - PortalReqType = None, PortalReqType2 = QuestBonus
   - Expected: Secondary not checked (only if primary exists)

5. Very high requirement values:
   - PortalReqValue = 999999
   - Expected: Handles large numbers correctly

PASS CRITERIA:
‚úì Edge cases handled gracefully
‚úì No crashes or exceptions
‚úì Logical behavior for invalid configs

================================================================================
22. SPLIT ARROW SYSTEM (FULLY IMPLEMENTED)
================================================================================

CURRENT STATUS: ‚úÖ Fully Implemented - Multi-target bow mechanics ready for testing

IMPLEMENTATION SUMMARY:
- Multi-target projectile mechanics for bows
- Configurable split count (0-10 arrows, default 3)
- Configurable range (0-50m, default 8m)
- Configurable damage multiplier (0-1.0x, default 0.6x)
- 60¬∞ cone angle validation
- Cross-landblock target detection
- PK status validation
- Proc handling with decay
- Death message modification
- Appraisal display

-------------------------------------------
TEST 22.1: Basic Split Arrow Setup
-------------------------------------------
‚ö†Ô∏è Requires Content Creation (bow with SplitArrows enabled)

PREREQUISITES:
- Bow weenie to modify
- Admin access to set properties

SETUP STEPS:
1. Modify bow weenie in database
2. Set PropertyBool.SplitArrows = true
3. Optional: Set PropertyInt.SplitArrowCount = 3 (default if not set)
4. Optional: Set PropertyFloat.SplitArrowRange = 8.0 (default)
5. Optional: Set PropertyFloat.SplitArrowDamageMultiplier = 0.6 (default)

PROPERTY DEFAULTS:
- SplitArrowCount: If not set, uses DEFAULT_SPLIT_ARROW = 3
- SplitArrowRange: If not set, uses 8.0 meters
- SplitArrowDamageMultiplier: If not set, uses 0.6 (60% damage)

TEST STEPS:
1. Equip bow with SplitArrows = true
2. Examine bow (appraisal)
3. Verify split arrow stats display

EXPECTED RESULTS - Appraisal Display:
- "Split Arrows: 3" (or configured count)
- "Split Arrow Range: 8.0m" (or configured range)
- "Split Arrow Damage: 60%" (or configured multiplier)

VERIFICATION:
- Check AppraiseInfo.cs BuildProperties()
- Verify SplitArrows, SplitArrowCount, SplitArrowRange, SplitArrowDamageMultiplier properties
- Values display in bow examination window

PASS CRITERIA:
‚úì Bow appraisal shows split arrow stats
‚úì Default values apply when not configured
‚úì Custom values display correctly

-------------------------------------------
TEST 22.2: Split Arrow Target Selection
-------------------------------------------
‚ö†Ô∏è Requires Multiple Mobs + Bow Setup

PREREQUISITES:
- Bow with SplitArrows = true, SplitArrowCount = 3
- 5+ mobs spawned within 8m of each other
- Clear area for testing

TEST STEPS:
1. Target primary mob
2. Ensure 4+ additional mobs within 8m range
3. Fire arrow at primary target
4. Observe split arrow behavior

EXPECTED RESULTS:
1. Primary arrow fires at targeted mob
2. 3 additional arrows fire at up to 3 nearest mobs
3. Mobs must be within 8m of primary target
4. Mobs must be within 60¬∞ cone in front of player
5. Each mob hit only once per shot
6. Cross-landblock targets included if in range

TARGET SELECTION LOGIC:
- Finds all valid targets within SplitArrowRange (8m default)
- Excludes primary target from split arrow list
- Validates 60¬∞ cone angle from player facing
- Sorts by distance (closest first)
- Takes up to SplitArrowCount additional targets
- Validates PK status (NPK can't hit PK, vice versa)

VERIFICATION:
- Check Creature_Missile.cs CreateSplitArrows()
- Check FindValidSplitTargets() method
- Check IsTargetInValidAngle() for 60¬∞ cone
- Verify cross-landblock detection (gets all PhysicsObjs in 96m radius)

EDGE CASES:
[ ] Only 1 mob in range (no split arrows fire)
[ ] 2 mobs in range (1 split arrow fires)
[ ] 10 mobs in range, SplitArrowCount = 3 (3 closest hit)
[ ] Mobs behind player (excluded by 60¬∞ cone)
[ ] Mobs to the side (included if within 60¬∞)
[ ] Cross-landblock targets (should work)

PASS CRITERIA:
‚úì Splits fire at correct number of targets
‚úì Range validation works (8m default)
‚úì Angle validation works (60¬∞ cone)
‚úì Closest targets prioritized
‚úì Cross-landblock detection works
‚úì No duplicate hits per shot

-------------------------------------------
TEST 22.3: Split Arrow Damage Multiplier
-------------------------------------------
‚úÖ Can Test Now (with split arrow bow)

PREREQUISITES:
- Bow with SplitArrows = true
- SplitArrowDamageMultiplier = 0.6 (60%)
- Multiple mobs for testing
- Combat log or damage tracking

TEST STEPS:
1. Fire normal arrow (no split) at mob, record damage
2. Fire split arrow at primary target, record damage
3. Check split arrow targets, record their damage

EXPECTED RESULTS:
- Primary target: Full damage (100%)
- Split arrow targets: 60% damage (0.6 multiplier)
- Example: If base damage = 100, split arrows deal 60

VERIFICATION:
- Check DamageEvent.cs lines 385-391
- Verify PropertyBool.IsSplitArrow checked
- Verify SplitArrowDamageMultiplier applied
- Default multiplier: 0.6 if not configured

FORMULA:
- Damage *= SplitArrowDamageMultiplier (from launcher)
- Applied after all other damage calculations
- Applied before final damage mitigated calculation

EDGE CASES:
[ ] SplitArrowDamageMultiplier = 1.0 (full damage)
[ ] SplitArrowDamageMultiplier = 0.1 (10% damage)
[ ] Multiplier not set (should default to 0.6)
[ ] Critical hits on split arrows (multiplier applies to crit damage too)

PASS CRITERIA:
‚úì Split arrows deal reduced damage
‚úì Primary target takes full damage
‚úì Multiplier configurable per bow
‚úì Default value (0.6) works

-------------------------------------------
TEST 22.4: Split Arrow PK Validation
-------------------------------------------
‚úÖ Can Test Now (with PK/NPK characters)

PREREQUISITES:
- Bow with SplitArrows = true
- PK character
- NPK character
- Mixed PK/NPK mobs in range

TEST STEPS:
1. PK player fires at PK mob with NPK mobs nearby
2. Observe split arrow targets
3. NPK player fires at NPK mob with PK mobs nearby
4. Observe split arrow targets

EXPECTED RESULTS:
- PK player: Splits ONLY hit PK-valid targets (PK mobs, PK players)
- NPK player: Splits ONLY hit NPK-valid targets (NPK mobs, no PK players)
- Invalid PK targets excluded from split arrow list

VERIFICATION:
- Check FindValidSplitTargets() PK status validation
- Check IsPKTarget() or similar PK validation logic
- Verify both Player vs Player and Player vs Creature PK rules

PASS CRITERIA:
‚úì PK status validated for all split targets
‚úì Invalid targets excluded
‚úì No accidental PK flagging from splits

-------------------------------------------
TEST 22.5: Split Arrow Proc Handling
-------------------------------------------
‚ö†Ô∏è Requires Bow with Procs (e.g., Critical Strike, Crushing Blow)

PREREQUISITES:
- Bow with SplitArrows = true
- Bow with proc (e.g., 10% Critical Strike chance)
- Multiple mobs for testing
- Proc tracking/combat log

TEST STEPS:
1. Fire split arrow at multiple targets
2. Observe proc triggers
3. Track which arrows proc and which don't

EXPECTED RESULTS:
- Primary arrow: Full proc chance (e.g., 10%)
- Split arrows: Decayed proc chance
- Each split arrow independently rolls for proc
- Proc decay formula applied (chance *= 0.95^(i-1))

PROC DECAY EXAMPLE (10% base proc):
- Arrow 1 (primary): 10% chance
- Arrow 2 (split 1): 9.5% chance (10% √ó 0.95)
- Arrow 3 (split 2): 9.025% chance (10% √ó 0.95¬≤)
- Arrow 4 (split 3): 8.574% chance (10% √ó 0.95¬≥)

VERIFICATION:
- Check Creature_Missile.cs CreateSplitArrows()
- Verify wo.Enchantments decay applied
- Verify wo.EnchantmentRegistry.Remove/Add cycle
- Enchantment indices decremented by decay

PASS CRITERIA:
‚úì Procs work on split arrows
‚úì Proc chance decays per split
‚úì Independent rolls for each arrow
‚úì Primary arrow keeps full proc chance

-------------------------------------------
TEST 22.6: Split Arrow Death Messages
-------------------------------------------
‚úÖ Can Test Now (kill with split arrow)

PREREQUISITES:
- Bow with SplitArrows = true
- Mob to kill with split arrow (not primary target)

TEST STEPS:
1. Damage mob to low HP
2. Fire split arrow where this mob is a split target (not primary)
3. Split arrow kills the mob
4. Check death message

EXPECTED RESULTS:
- Normal kill: "You killed [Mob Name]!"
- Split arrow kill: "Your split arrow kills [Mob Name]!"
- Message modification only for kills via split arrow projectile

VERIFICATION:
- Check GameEventKillerNotification.cs
- Verify IsSplitArrow property checked
- Verify message string modified to "Your split arrow kills"

PASS CRITERIA:
‚úì Death message modified for split arrow kills
‚úì Normal message for primary target kills
‚úì Message accurate and grammatically correct

-------------------------------------------
TEST 22.7: Environment Hit Spam Reduction
-------------------------------------------
‚úÖ Can Test Now (fire at environment)

PREREQUISITES:
- Bow with SplitArrows = true
- Clear area with no mobs

TEST STEPS:
1. Fire split arrow at ground (no targets)
2. Observe environment hit messages

EXPECTED RESULTS:
- Only 1 environment hit message per shot
- Message: "You hit the environment"
- Spam reduction via LastSplitArrow tracking

VERIFICATION:
- Check ProjectileCollisionHelper.cs OnCollideEnvironment()
- Verify LastSplitArrow property (PropertyInstanceId.LastSplitArrow)
- Second+ environment hits from same split ignored

PASS CRITERIA:
‚úì Only 1 environment hit message per shot
‚úì No message spam
‚úì Works correctly

-------------------------------------------
TEST 22.8: Split Arrow with Max Count
-------------------------------------------
‚ö†Ô∏è Requires Bow Setup

TEST CASES:

1. SplitArrowCount = 0:
   - Expected: No split arrows fire (normal bow behavior)

2. SplitArrowCount = 1:
   - Expected: 1 split arrow fires

3. SplitArrowCount = 10 (max):
   - Expected: Up to 10 split arrows fire

4. SplitArrowCount = 100 (above max):
   - Expected: Capped at 10 (MAX_SPLIT_ARROW_COUNT)

VERIFICATION:
- Check Creature_Missile.cs MAX_SPLIT_ARROW_COUNT = 10
- Verify Math.Min(count, MAX_SPLIT_ARROW_COUNT)

PASS CRITERIA:
‚úì Count = 0 disables splits
‚úì Count = 1-10 works correctly
‚úì Count > 10 capped at 10

-------------------------------------------
TEST 22.9: Split Arrow Range Validation
-------------------------------------------
‚ö†Ô∏è Requires Bow Setup + Multiple Mobs

TEST STEPS:
1. Set SplitArrowRange = 5.0
2. Place mobs at 4m, 6m, 8m from primary target
3. Fire split arrow

EXPECTED RESULTS:
- 4m mob: Hit by split arrow
- 6m mob: NOT hit (outside 5m range)
- 8m mob: NOT hit (outside 5m range)

VERIFICATION:
- Check FindValidSplitTargets() distance calculation
- Verify range check: distance <= SplitArrowRange

PASS CRITERIA:
‚úì Range validation accurate
‚úì Only targets within range hit
‚úì Range configurable per bow

================================================================================
23. TEST COMPLETION CHECKLIST

================================================================================
22. TEST COMPLETION CHECKLIST
================================================================================

Use this to track your testing progress:

COMMANDS:
[ ] /qb - Quest bonus display
[ ] /bonus - XP bonus breakdown (QB, ENL, Equipment, PK dungeon)
[ ] /aug and /augs - Conquest custom augmentations
[ ] /top qb - Quest bonus leaderboard
[ ] /top level - Level leaderboard
[ ] /top enl - Enlightenment leaderboard
[ ] /top bank - Banked pyreals leaderboard
[ ] /top lum - Banked luminance leaderboard
[ ] /top augs - Total augmentations leaderboard
[ ] /bank balance - View bank balances
[ ] /bank deposit (all types) - Deposit currency
[ ] /bank withdraw (all types) - Withdraw currency
[ ] /bank transfer (all types) - Transfer to other players
[ ] /pk (all variations) - PK status management
[ ] /cg - Chat relay to Discord General
[ ] /trade - Chat relay to Discord Trade
[ ] /fship create <name> - Create fellowship
[ ] /fship add <name> - Add player to fellowship
[ ] /fship remove <name> - Remove player from fellowship
[ ] /fship landblock - Mass invite landblock players
[ ] /fship leave - Leave fellowship
[ ] /fship disband - Disband fellowship

ADMIN COMMANDS:
[ ] @export-discord (weenie)
[ ] @export-discord (recipe)
[ ] @export-discord (quest)
[ ] @export-discord (spell)
[ ] @export-discord (landblock)
[ ] @import-discord
[ ] @export-discord-clothing
[ ] @import-discord-clothing
[ ] @world open
[ ] @world close
[ ] @shutdown

DISCORD RESTART BOT COMMANDS:
[ ] startserver - Start ACE server with visible console
[ ] stopserver - Gracefully stop server with stop-now command
[ ] restartserver - Graceful restart (stop + 3s delay + start)
[ ] status - Show server online/offline and uptime

SYSTEMS:
[ ] ENL cap at 100
[ ] ENL +1% XP per level
[ ] ENL +1 all stats per level
[ ] ENL +1 DR/DRR per 25 levels
[ ] QB XP bonus (0.01% per quest)
[ ] QB tracking (first completions only)
[ ] QB account-wide tracking
[ ] QB mule exclusion
[ ] Banking thread safety
[ ] Character limits (marketplace)
[ ] No item loss on PK death
[ ] PK 5-minute minimum duration
[ ] PK 20-minute death cooldown
[ ] PK timer prevents unflagging
[ ] PK dungeon 20-minute per-dungeon lockout (PvP deaths only)
[ ] Soul fragment level 50 requirement (PvP deaths only)
[ ] Soul fragment daily cap notification (20/day with countdown)
[ ] Soul fragment notification throttling (5-minute intervals)
[ ] Soul fragment property wrappers (all 8 properties)
[ ] Mutation script null check (prevents Corrupted Mazule crash)
[ ] Tinkering to 20x
[ ] Leaderboard caching
[ ] Fellowship system (create, add, remove, landblock, leave, disband)
[ ] Fellowship landblock mass invite with level restrictions
[ ] Fellowship marketplace blocking
[ ] /bonus command multiplicative XP calculation
[ ] Emote: IncrementInt64Stat / DecrementInt64Stat
[ ] Emote: SetAttributeStat (set ranks without XP cost)
[ ] Emote: GrantAttributeStat (permanent base increase)
[ ] Emote: GrantVitalStat (permanent vital increase)
[ ] Emote: SetEnvironment (fog and sound effects)
[ ] Enrage properties defined (9011-9017, 9025-9027)
[ ] Portal restriction properties defined (9019-9024)

DISCORD INTEGRATION:
[ ] Game‚ÜíDiscord chat relay (General)
[ ] Game‚ÜíDiscord chat relay (Trade)
[ ] Discord‚ÜíGame chat relay
[ ] Admin audit logging to Discord
[ ] World open/close events to Discord
[ ] Server shutdown events to Discord
[ ] SQL export to Discord (weenie/recipe/quest/spell/landblock)
[ ] SQL import from Discord
[ ] Clothing export/import
[ ] Discord connection error handling
[ ] Null checks prevent crashes

DISCORD RESTART BOT (Windows VM):
[ ] Bot connects to Discord successfully
[ ] System tray icon appears
[ ] startserver shows console window
[ ] stopserver sends stop-now command (graceful shutdown)
[ ] 30-second timeout before force kill
[ ] restartserver does full stop-wait-start sequence
[ ] Admin log posted on restart
[ ] status command shows accurate uptime
[ ] Real-time log monitoring (ACE_Log.txt tailing)
[ ] Crash detection and severity analysis
[ ] Crash stack traces posted to Discord
[ ] WARN/ERROR batching (60-second intervals)
[ ] Error grouping by type (top 10)
[ ] In-memory batching (no disk writes)
[ ] Authorization checks (AuthorizedUserIds)
[ ] Edge case handling (already running, already stopped, etc.)
[ ] Process reference tracking for console commands
[ ] Graceful error handling (missing files, invalid channels)

================================================================================
23. TRANSFER MONITORING & CHARACTER TRACKING (ANTI-RMT/MULTI-BOX)
================================================================================
STATUS: ‚úÖ FULLY IMPLEMENTED (Server Startup Initialization Active)

OVERVIEW:
The transfer monitoring system tracks all item transfers between players for
detecting RMT (Real Money Trading), account sharing, and multi-boxing violations.
Character tracking logs all login/logout events with IP addresses for investigation.

INITIALIZATION:
- TransferLogger.InitializeTransferMonitoring() called on server startup
- CharacterTracker tracks login/logout automatically
- 90-day data retention with auto-cleanup
- Privacy compliance features (IP anonymization)

-------------------------------------------
TEST 23.1: Initial System Setup
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Fresh server start
- Admin account
- Database access

TEST STEPS:
1. Start server and check logs for "Initializing TransferLogger..."
2. Run `/bankaudit migrate` to create all tables
3. Run `/bankaudit status` to view configuration
4. Verify tables exist in ace_shard database:
   - transfer_logs
   - transfer_summaries
   - tracked_items
   - transfer_blacklist
   - transfer_monitoring_configs
   - char_tracker

EXPECTED RESULTS:
- Server log shows successful initialization
- Tables created with proper indexes
- Default config loaded (100k threshold, 24h window, tracking enabled)

-------------------------------------------
TEST 23.2: Tracked Items Management
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Run `/bankaudit items list` (should be empty initially)
2. Run `/bankaudit items add Pyreal Mote`
3. Run `/bankaudit items add Trade Note` (partial match)
4. Run `/bankaudit items add Legendary` (matches all legendary items)
5. Run `/bankaudit items list` to verify additions
6. Run `/bankaudit items remove Pyreal Mote`
7. Verify removal with `/bankaudit items list`

EXPECTED RESULTS:
- Items added successfully
- Partial matching works (e.g., "Trade Note" matches all trade notes)
- Case-insensitive matching works
- Items can be removed

-------------------------------------------
TEST 23.3: Bank Transfer Logging
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two characters (Player A and Player B)
- Some pyreals in Player A's inventory
- Tracked item added (e.g., `/bankaudit items add Pyreal Mote`)

TEST STEPS:
1. Player A: `/bank deposit 10000` (deposit pyreals)
2. Player A: `/bank transfer [PlayerB] 5000 test transfer`
3. Admin: `/bankaudit log [PlayerA] 1`
4. Verify transfer appears in logs

EXPECTED RESULTS:
- Transfer logged with timestamp, accounts, amounts
- Both players' account creation dates logged
- Character creation dates logged
- Transfer type shows "Bank Transfer"

-------------------------------------------
TEST 23.4: Trade Logging
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Two players in-game
- Tracked items in inventory

TEST STEPS:
1. Initiate trade between two players
2. Exchange tracked items (e.g., Pyreal Motes)
3. Complete trade
4. Run `/bankaudit log [PlayerName] 1`
5. Verify both sides of trade logged

EXPECTED RESULTS:
- Both sides of trade logged separately
- Item names and quantities recorded
- Transfer type shows "Trade"
- Account information captured

-------------------------------------------
TEST 23.5: Character Login/Logout Tracking
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Test character
- Database access to char_tracker table

TEST STEPS:
1. Log in with a character
2. Check server logs for "Character login logged: [CharName]"
3. Play for a few minutes
4. Log out
5. Check server logs for "Character logout logged: [CharName]"
6. Query database: `SELECT * FROM char_tracker ORDER BY Id DESC LIMIT 5;`

EXPECTED RESULTS:
- Login record created with:
  * Character ID, Name, Account Name
  * IP address
  * Login timestamp
  * Landblock location
  * ConnectionDuration = 0 (on login)
- Logout updates ConnectionDuration to actual session length in seconds
- IP address captured correctly

-------------------------------------------
TEST 23.6: Suspicious Transfer Detection
-------------------------------------------
‚ö†Ô∏è Requires Suspicious Activity

PREREQUISITES:
- Two accounts with tracked items
- Default threshold: 100,000 value

TEST STEPS:
1. Configure threshold: `/bankaudit config threshold 50000`
2. Perform high-value transfers between accounts
3. Run `/bankaudit suspicious 1` to view alerts
4. Check for admin notifications (if enabled)

EXPECTED RESULTS:
- Transfers exceeding threshold flagged
- Admin notifications sent (if configured)
- Suspicious transfers queryable

-------------------------------------------
TEST 23.7: Transfer Patterns Analysis
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Multiple transfers between same players

TEST STEPS:
1. Perform 5+ transfers between Player A and Player B
2. Run `/bankaudit patterns [PlayerA] 7`
3. Review pattern detection output

EXPECTED RESULTS:
- Repeated transfer patterns detected
- Transfer counts shown per player pair
- Total value calculated
- Account ages displayed

-------------------------------------------
TEST 23.8: Blacklist Management
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Run `/bankaudit blacklist add player TestPlayer`
2. Run `/bankaudit blacklist add account TestAccount`
3. Run `/bankaudit blacklist list player`
4. Run `/bankaudit blacklist list account`
5. Perform transfer with blacklisted player
6. Verify transfer NOT logged
7. Run `/bankaudit blacklist remove player TestPlayer`

EXPECTED RESULTS:
- Players/accounts added to blacklist
- Blacklisted transfers excluded from monitoring
- Blacklist entries removable

-------------------------------------------
TEST 23.9: Configuration Management
-------------------------------------------
‚úÖ Can Test Now

TEST STEPS:
1. Run `/bankaudit config threshold 200000`
2. Run `/bankaudit config timewindow 48`
3. Run `/bankaudit config trackall on`
4. Run `/bankaudit config transferlogging on`
5. Run `/bankaudit status` to verify changes

EXPECTED RESULTS:
- Threshold updated to 200,000
- Time window set to 48 hours
- TrackAllItems enabled (tracks everything, not just listed items)
- Configuration persisted to database

-------------------------------------------
TEST 23.10: Data Retention & Privacy
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Old transfer/login records in database

TEST STEPS:
1. Run `/bankaudit cleanup 30` (delete logs older than 30 days)
2. Check server logs for deletion count
3. Verify old records removed from database
4. Check automatic cleanup on server startup (runs daily)

EXPECTED RESULTS:
- Old records deleted successfully
- Automatic cleanup runs on server startup
- char_tracker auto-cleanup (90-day retention)
- IP anonymization available (privacy compliance)

-------------------------------------------
TEST 23.11: IP Pattern Analysis
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Multiple logins from different IPs

TEST STEPS:
1. Run `/bankaudit ip [PlayerName] 7`
2. Review IP patterns and timestamps

EXPECTED RESULTS:
- All IPs used by player shown
- Login timestamps displayed
- Useful for detecting account sharing

-------------------------------------------
TEST 23.12: Top Transfer Participants
-------------------------------------------
‚úÖ Can Test Now

PREREQUISITES:
- Active transfer history

TEST STEPS:
1. Run `/bankaudit top 7`
2. Review most active transferrers

EXPECTED RESULTS:
- Top players by transfer volume shown
- Transfer counts and values displayed
- Ranked by activity level

EDGE CASES:
[ ] Negative values handled
[ ] Null values handled
[ ] Boundary values (0, max)
[ ] Concurrent operations
[ ] Database disconnection
[ ] Invalid command parameters
[ ] Character name with spaces
[ ] Offline player transfers

================================================================================
END OF TESTING GUIDE
================================================================================

For questions or issues during testing, refer to:
- Conquest_Proposal_Review.txt (implementation details)
- Database schema (authentication and shard databases)

RECENT UPDATES (Version 1.3 - 2025-12-25):
- Added Section 23: Transfer Monitoring & Character Tracking (Anti-RMT/Multi-Box)
- Fixed CharacterTracker.LogCharacterLogin() - now called on player login
- Added TransferLogger.InitializeTransferMonitoring() to server startup (Program.cs)
- Ported Portal Restrictions, Split Arrows, and Enrage systems from ACECustomLocal
- Fixed all pre-existing ACEMain build errors (EmptyAction, GameMessageAttribute, CorePlating)
- Added Discord bot timedstop command for graceful server shutdowns
- Discord bot now detects already-running servers for stop/restart commands
- Identified character_snapshot table as orphaned/unused (safe to drop)

RECENT UPDATES (Version 1.2 - 2025-12-24):
- Added Discord Restart Bot section (Section 17) with full testing procedures
- Updated soul fragment tests with level 50 requirement for PvP deaths
- Added daily cap notification testing (20/day with countdown timer)
- Added 20-minute per-dungeon PK death lockout testing
- Added mutation script null check verification (Corrupted Mazule fix)
- Updated property wrappers checklist (8 soul fragment properties)

Good luck with testing!
